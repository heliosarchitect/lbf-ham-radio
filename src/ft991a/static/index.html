<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FT-991A // LCARS INTERFACE</title>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /*
         * FT-991A Ham Radio Control — LCARS Theme
         * Based on LBF Enterprise Dashboard LCARS framework
         */

        :root {
            /* LCARS Colors */
            --lcars-orange: #ff9933;
            --lcars-gold: #ffcc66;
            --lcars-peach: #ffcc99;
            --lcars-purple: #664466;
            --lcars-lilac: #cc99cc;
            --lcars-blue: #99ccff;
            --lcars-navy: #3366cc;
            --lcars-teal: #006699;
            --lcars-green: #99dd66;
            --lcars-red: #cc4444;
            --lcars-bg: #000000;
            --lcars-text: #99ccff;

            /* Spacing */
            --gap: 1rem;
            --radius: 2rem;
            --radius-sm: 1rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Antonio', 'Arial Narrow', sans-serif;
            background: var(--lcars-bg);
            color: var(--lcars-text);
            line-height: 1.5;
            font-size: 16px;
            min-height: 100vh;
        }

        a { color: var(--lcars-blue); text-decoration: none; }
        a:hover { color: var(--lcars-gold); }

        /* Star field background */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image:
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.4), transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.3), transparent),
                radial-gradient(1px 1px at 230px 80px, rgba(255,255,255,0.2), transparent),
                radial-gradient(2px 2px at 300px 150px, rgba(255,255,255,0.3), transparent),
                radial-gradient(1px 1px at 370px 50px, rgba(255,255,255,0.4), transparent),
                radial-gradient(2px 2px at 450px 180px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 520px 100px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 600px 200px, rgba(255,255,255,0.2), transparent);
            background-size: 800px 250px;
            animation: twinkle 8s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes twinkle {
            0% { opacity: 0.3; }
            100% { opacity: 0.6; }
        }

        /* ═══════════════════════════════
           LCARS FRAME LAYOUT
           ═══════════════════════════════ */

        .lcars-frame {
            display: grid;
            grid-template-columns: 90px 1fr;
            grid-template-rows: auto 1fr auto;
            min-height: 100vh;
            gap: 6px;
            padding: 6px;
        }

        /* --- Sidebar --- */
        .lcars-sidebar {
            grid-row: 1 / -1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .lcars-sidebar-top {
            background: var(--lcars-lilac);
            height: 70px;
            border-radius: var(--radius) 0 0 0;
        }

        .lcars-sidebar-nav {
            background: var(--lcars-orange);
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-top: 1.5rem;
        }

        .lcars-sidebar-bottom {
            background: var(--lcars-purple);
            height: 60px;
            border-radius: 0 0 0 var(--radius);
        }

        .lcars-nav-item {
            background: var(--lcars-gold);
            margin: 3px 0;
            margin-right: -6px;
            padding: 0.6rem 0.75rem;
            border-radius: var(--radius) 0 0 var(--radius);
            color: #000;
            text-decoration: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.05em;
            transition: all 0.2s;
            display: block;
            cursor: pointer;
        }

        .lcars-nav-item:hover {
            background: var(--lcars-peach);
            padding-left: 1rem;
            color: #000;
        }

        .lcars-nav-item.active {
            background: var(--lcars-blue);
        }

        /* --- Header Bar --- */
        .lcars-header {
            display: flex;
            align-items: stretch;
            gap: 6px;
        }

        .lcars-header-elbow {
            background: var(--lcars-lilac);
            width: 160px;
            border-radius: 0 0 var(--radius) 0;
            position: relative;
            min-height: 60px;
        }

        .lcars-header-elbow::after {
            content: '';
            position: absolute;
            bottom: 0; right: 0;
            width: 55%;
            height: 28px;
            background: var(--lcars-bg);
            border-radius: var(--radius) 0 0 0;
        }

        .lcars-header-bar {
            flex: 1;
            background: var(--lcars-orange);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            height: 60px;
        }

        .lcars-header-end {
            background: var(--lcars-blue);
            width: 200px;
            border-radius: 0 var(--radius) var(--radius) 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .lcars-title {
            color: #000;
            font-size: 1.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .lcars-connection-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #000;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .lcars-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--lcars-red);
            transition: background 0.3s ease;
        }

        .lcars-status-indicator.connected {
            background: var(--lcars-green);
        }

        .lcars-reconnect-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.8rem;
            background: #000;
            color: var(--lcars-gold);
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 2px solid var(--lcars-gold);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .lcars-reconnect-btn:hover {
            background: var(--lcars-gold);
            color: #000;
        }

        /* --- Content Area --- */
        .lcars-content {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Tab Content Areas */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ═══════════════════════════════
           LCARS PANELS
           ═══════════════════════════════ */

        .lcars-panel {
            background: rgba(153, 204, 255, 0.05);
            border: 2px solid var(--lcars-teal);
            border-radius: var(--radius);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .lcars-panel::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--lcars-blue), transparent);
            animation: scanline 4s ease-in-out infinite;
            opacity: 0;
        }

        .lcars-panel:hover::before { opacity: 1; }

        @keyframes scanline {
            0% { transform: translateY(0); }
            100% { transform: translateY(100%); height: 100%; }
        }

        .lcars-panel-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .lcars-panel-indicator {
            width: 60px;
            height: 24px;
            background: var(--lcars-orange);
            border-radius: var(--radius);
        }
        .lcars-panel-indicator.blue { background: var(--lcars-blue); }
        .lcars-panel-indicator.green { background: var(--lcars-green); }
        .lcars-panel-indicator.purple { background: var(--lcars-purple); }

        .lcars-panel-title {
            color: var(--lcars-orange);
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ═══════════════════════════════
           BUTTONS
           ═══════════════════════════════ */

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.5rem 1.2rem;
            border-radius: var(--radius);
            border: 2px solid var(--lcars-blue);
            background: rgba(0, 0, 0, 0.6);
            color: var(--lcars-blue);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--lcars-blue);
            color: #000;
            text-decoration: none;
        }

        .btn.primary {
            border-color: var(--lcars-orange);
            color: var(--lcars-orange);
        }

        .btn.primary:hover {
            background: var(--lcars-orange);
            color: #000;
        }

        .btn.danger {
            border-color: var(--lcars-red);
            color: var(--lcars-red);
        }

        .btn.danger:hover {
            background: var(--lcars-red);
            color: #fff;
        }

        .btn.success {
            border-color: var(--lcars-green);
            color: var(--lcars-green);
        }

        .btn.success:hover {
            background: var(--lcars-green);
            color: #000;
        }

        .btn-small {
            padding: 0.3rem 0.8rem;
            font-size: 0.75rem;
            border-width: 1px;
        }

        /* ═══════════════════════════════
           FREQUENCY DISPLAY
           ═══════════════════════════════ */

        .frequency-display {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--lcars-gold);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .frequency-display::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px;
            height: 4px;
            background: var(--lcars-gold);
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .frequency-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Antonio', monospace;
            color: var(--lcars-gold);
            text-shadow: 0 0 10px var(--lcars-gold);
            letter-spacing: 2px;
        }

        .frequency-label {
            color: var(--lcars-peach);
            font-size: 1rem;
            font-weight: 600;
            margin-top: 0.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* ═══════════════════════════════
           FINE TUNING CONTROLS
           ═══════════════════════════════ */

        .fine-tune-container {
            background: rgba(0, 102, 153, 0.1);
            border: 1px solid var(--lcars-teal);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .fine-tune-container label {
            display: block;
            color: var(--lcars-gold);
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .step-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.3rem;
            margin-bottom: 1rem;
        }

        .step-btn {
            padding: 0.4rem 0.2rem;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--lcars-purple);
            border-radius: var(--radius-sm);
            color: var(--lcars-purple);
            font-family: inherit;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 32px;
        }

        .step-btn:hover {
            background: var(--lcars-purple);
            color: #fff;
        }

        .step-btn.active {
            background: var(--lcars-gold);
            border-color: var(--lcars-gold);
            color: #000;
        }

        .nudge-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .nudge-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--lcars-blue);
            background: rgba(0, 0, 0, 0.6);
            color: var(--lcars-blue);
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .nudge-btn:hover {
            background: var(--lcars-blue);
            color: #000;
            transform: scale(1.1);
        }

        .nudge-btn:active {
            transform: scale(0.95);
        }

        .step-display {
            min-width: 100px;
            text-align: center;
            color: var(--lcars-peach);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* ═══════════════════════════════
           VFO CONTROLS
           ═══════════════════════════════ */

        .vfo-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .vfo-knob {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .knob-container {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .knob {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--lcars-gold), var(--lcars-navy));
            border: 4px solid var(--lcars-orange);
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: all 0.3s ease;
        }

        .knob:hover {
            border-color: var(--lcars-blue);
            box-shadow: 0 0 20px rgba(255, 153, 51, 0.6);
        }

        .knob::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 25px;
            background: var(--lcars-orange);
            border-radius: 3px;
        }

        .knob-label {
            font-size: 1rem;
            color: var(--lcars-peach);
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* ═══════════════════════════════
           PTT BUTTON
           ═══════════════════════════════ */

        .ptt-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .ptt-button {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--lcars-green), var(--lcars-navy));
            border: 6px solid var(--lcars-green);
            color: #000;
            font-size: 1.4rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .ptt-button:hover:not(:disabled) {
            border-color: var(--lcars-gold);
            box-shadow: 0 0 25px rgba(153, 221, 102, 0.8);
            transform: scale(1.05);
        }

        .ptt-button.active {
            background: radial-gradient(circle at 30% 30%, var(--lcars-red), #330000);
            border-color: var(--lcars-red);
            color: #fff;
            animation: ptt-pulse 1s infinite;
        }

        @keyframes ptt-pulse {
            0% { box-shadow: 0 0 0 0 rgba(204, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(204, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(204, 68, 68, 0); }
        }

        .lockout-toggle {
            border-color: var(--lcars-purple);
            color: var(--lcars-purple);
        }

        .lockout-toggle.active {
            background: var(--lcars-red);
            border-color: var(--lcars-red);
            color: #fff;
            animation: lockout-warning 2s infinite;
        }

        @keyframes lockout-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ═══════════════════════════════
           METERS
           ═══════════════════════════════ */

        .meter {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--lcars-blue);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .meter::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px;
            height: 4px;
            background: var(--lcars-blue);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .meter-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--lcars-peach);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .meter-value {
            font-weight: 700;
            color: var(--lcars-gold);
            font-size: 1.1rem;
        }

        .meter-bar {
            width: 100%;
            height: 12px;
            background: rgba(0, 102, 153, 0.3);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--lcars-teal);
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--lcars-green), var(--lcars-gold), var(--lcars-red));
            transition: width 0.4s ease;
            border-radius: var(--radius);
        }

        /* ═══════════════════════════════
           SELECTOR GRIDS
           ═══════════════════════════════ */

        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .selector-btn {
            padding: 0.5rem 0.3rem;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--lcars-lilac);
            border-radius: var(--radius-sm);
            color: var(--lcars-lilac);
            font-family: inherit;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 36px;
        }

        .selector-btn:hover {
            background: var(--lcars-lilac);
            color: #000;
        }

        .selector-btn.active {
            background: var(--lcars-gold);
            border-color: var(--lcars-gold);
            color: #000;
        }

        /* ═══════════════════════════════
           FORMS
           ═══════════════════════════════ */

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            color: var(--lcars-gold);
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.4rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.65rem 0.9rem;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--lcars-blue);
            border-radius: 0.5rem;
            color: #fff;
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--lcars-gold);
            box-shadow: 0 0 10px rgba(255, 153, 0, 0.3);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        /* ═══════════════════════════════
           STATUS GRID
           ═══════════════════════════════ */

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .status-item {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--lcars-purple);
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            text-align: center;
            position: relative;
        }

        .status-item::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px;
            height: 3px;
            background: var(--lcars-purple);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .status-label {
            font-size: 0.8rem;
            color: var(--lcars-peach);
            margin-bottom: 0.4rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-value {
            font-weight: 700;
            color: var(--lcars-text);
            font-size: 1rem;
        }

        .status-value.active { color: var(--lcars-green); }
        .status-value.danger { color: var(--lcars-red); }

        /* ═══════════════════════════════
           POWER SLIDER
           ═══════════════════════════════ */

        .power-slider {
            appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(0, 102, 153, 0.3);
            border-radius: var(--radius);
            outline: none;
            margin: 0 1rem;
            border: 1px solid var(--lcars-teal);
        }

        .power-slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--lcars-gold);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 204, 102, 0.5);
        }

        .power-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: var(--lcars-gold);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(255, 204, 102, 0.5);
        }

        /* Volume Slider (similar styling) */
        .volume-slider {
            appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(0, 102, 153, 0.3);
            border-radius: var(--radius);
            outline: none;
            margin: 0 1rem;
            border: 1px solid var(--lcars-teal);
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--lcars-green);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(153, 221, 102, 0.5);
        }

        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--lcars-green);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(153, 221, 102, 0.5);
        }

        /* ═══════════════════════════════
           MAIN GRID
           ═══════════════════════════════ */

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* ═══════════════════════════════
           MEMORY CHANNEL LIST
           ═══════════════════════════════ */

        .memory-list {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--lcars-blue);
            border-radius: var(--radius-sm);
            max-height: 400px;
            overflow-y: auto;
        }

        .memory-item {
            display: grid;
            grid-template-columns: 60px 150px 80px 1fr auto;
            gap: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid var(--lcars-teal);
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .memory-item:hover {
            background: rgba(255, 204, 102, 0.1);
            border-bottom-color: var(--lcars-gold);
        }

        .memory-item:last-child {
            border-bottom: none;
        }

        .memory-item.current {
            background: rgba(153, 221, 102, 0.15);
            border-left: 4px solid var(--lcars-green);
            border-bottom-color: var(--lcars-green);
        }

        .memory-item.empty {
            opacity: 0.4;
            font-style: italic;
        }

        .memory-channel {
            font-weight: 700;
            color: var(--lcars-gold);
            text-align: center;
            font-family: 'Antonio', monospace;
            font-size: 0.9rem;
        }

        .memory-frequency {
            color: var(--lcars-text);
            font-family: 'Antonio', monospace;
            font-weight: 600;
        }

        .memory-mode {
            color: var(--lcars-peach);
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }

        .memory-label {
            color: var(--lcars-lilac);
            font-size: 0.8rem;
            font-style: normal;
        }

        .memory-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .memory-action-btn {
            padding: 0.2rem 0.5rem;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--lcars-blue);
            border-radius: var(--radius-sm);
            color: var(--lcars-blue);
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .memory-action-btn:hover {
            background: var(--lcars-blue);
            color: #000;
        }

        .memory-action-btn.recall {
            border-color: var(--lcars-green);
            color: var(--lcars-green);
        }

        .memory-action-btn.recall:hover {
            background: var(--lcars-green);
        }

        .memory-action-btn.delete {
            border-color: var(--lcars-red);
            color: var(--lcars-red);
        }

        .memory-action-btn.delete:hover {
            background: var(--lcars-red);
            color: #fff;
        }

        /* ═══════════════════════════════
           DIAGNOSTIC PANELS
           ═══════════════════════════════ */

        .diagnostic-item {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--lcars-purple);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .diagnostic-item h4 {
            color: var(--lcars-gold);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .error-log {
            background: rgba(204, 68, 68, 0.1);
            border: 1px solid var(--lcars-red);
            border-radius: var(--radius-sm);
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .error-entry {
            color: var(--lcars-red);
            margin-bottom: 0.5rem;
            padding: 0.25rem;
            border-left: 3px solid var(--lcars-red);
            padding-left: 0.75rem;
        }

        .error-timestamp {
            color: var(--lcars-peach);
            font-size: 0.75rem;
        }

        /* ═══════════════════════════════
           MOBILE NAVIGATION BAR
           ═══════════════════════════════ */

        .mobile-nav-bar {
            display: none; /* Hidden on desktop */
            background: rgba(255, 153, 51, 0.15);
            border: 2px solid var(--lcars-orange);
            border-radius: var(--radius-sm);
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .mobile-nav-container {
            display: flex;
            gap: 0.5rem;
            min-width: max-content;
            align-items: center;
        }

        .mobile-nav-item {
            background: var(--lcars-gold);
            color: #000;
            border: none;
            border-radius: var(--radius);
            padding: 0.4rem 0.8rem;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            min-height: 44px; /* Touch-friendly */
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .mobile-nav-item:hover {
            background: var(--lcars-peach);
            transform: translateY(-1px);
        }

        .mobile-nav-item.active {
            background: var(--lcars-blue);
            color: #000;
            box-shadow: 0 2px 8px rgba(153, 204, 255, 0.4);
        }

        /* ═══════════════════════════════
           RESPONSIVE
           ═══════════════════════════════ */

        @media (max-width: 768px) {
            .lcars-frame {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .lcars-sidebar {
                display: none;
            }

            .mobile-nav-bar {
                display: block; /* Show on mobile */
            }
            
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .frequency-value {
                font-size: 2rem;
            }
            
            .ptt-button {
                width: 120px;
                height: 120px;
                font-size: 1.2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }

            .step-selector {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* ═══════════════════════════════
           AUDIO PANEL STYLING  
           ═══════════════════════════════ */

        .audio-code-block {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--lcars-teal);
            padding: 1.5rem;
            border-radius: var(--radius-sm);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--lcars-text);
            overflow-x: auto;
        }

        .audio-code-comment {
            color: var(--lcars-peach);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .placeholder-message {
            background: rgba(255, 204, 102, 0.1);
            border: 1px solid var(--lcars-gold);
            border-radius: var(--radius-sm);
            padding: 1rem;
            color: var(--lcars-gold);
            text-align: center;
            font-weight: 600;
            margin: 1rem 0;
        }

        /* Toggle switch styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--lcars-purple);
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: #fff;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--lcars-green);
        }

        input:checked + .toggle-slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <!-- LCARS Frame -->
    <div class="lcars-frame">
        
        <!-- LCARS Sidebar -->
        <div class="lcars-sidebar">
            <div class="lcars-sidebar-top"></div>
            <div class="lcars-sidebar-nav">
                <a href="#" class="lcars-nav-item active" data-tab="vfo-ctrl">VFO CTRL</a>
                <a href="#" class="lcars-nav-item" data-tab="modes">MODES</a>
                <a href="#" class="lcars-nav-item" data-tab="bands">BANDS</a>
                <a href="#" class="lcars-nav-item" data-tab="tx-pwr">TX PWR</a>
                <a href="#" class="lcars-nav-item" data-tab="meters">METERS</a>
                <a href="#" class="lcars-nav-item" data-tab="audio">AUDIO</a>
                <a href="#" class="lcars-nav-item" data-tab="sdr">SDR</a>
                <a href="#" class="lcars-nav-item" data-tab="scanner">SCANNER</a>
                <a href="#" class="lcars-nav-item" data-tab="system">SYSTEM</a>
                <a href="#" class="lcars-nav-item" data-tab="config">CONFIG</a>
                <a href="#" class="lcars-nav-item" data-tab="status">STATUS</a>
                <a href="#" class="lcars-nav-item" data-tab="diag">DIAG</a>
            </div>
            <div class="lcars-sidebar-bottom"></div>
        </div>

        <!-- LCARS Header -->
        <div class="lcars-header">
            <div class="lcars-header-elbow"></div>
            <div class="lcars-header-bar">
                <div class="lcars-title">FT-991A // LCARS INTERFACE</div>
            </div>
            <div class="lcars-header-end">
                <div class="lcars-connection-status">
                    <div class="lcars-status-indicator" id="connectionIndicator"></div>
                    <span id="connectionText">CONNECTING...</span>
                    <span id="versionLabel" style="margin-left: 0.8rem; font-size: 0.75rem; color: var(--lcars-lavender); opacity: 0.7; letter-spacing: 1px;" title="ft991a-control package version">v0.7.1</span>
                    <button class="lcars-reconnect-btn" id="reconnectButton" onclick="reconnectRadio()" 
                            title="Reconnect to FT-991A transceiver">↻ RECONNECT</button>
                </div>
            </div>
        </div>

        <!-- LCARS Content -->
        <div class="lcars-content">

            <!-- Mobile Navigation Bar (appears only on mobile) -->
            <div class="mobile-nav-bar" id="mobileNavBar">
                <div class="mobile-nav-container">
                    <button class="mobile-nav-item active" data-tab="vfo-ctrl" title="VFO Control - Frequency tuning and operations">VFO</button>
                    <button class="mobile-nav-item" data-tab="modes" title="Mode Selection - USB, LSB, CW, FM, FT8">MODES</button>
                    <button class="mobile-nav-item" data-tab="bands" title="Band Selection - HF/VHF/UHF amateur bands">BANDS</button>
                    <button class="mobile-nav-item" data-tab="tx-pwr" title="TX Power Control - Transmitter power settings">TX PWR</button>
                    <button class="mobile-nav-item" data-tab="meters" title="Meters - S-meter, SWR, power output">METERS</button>
                    <button class="mobile-nav-item" data-tab="audio" title="Audio Waterfall - Real-time spectrum display">AUDIO</button>
                    <button class="mobile-nav-item" data-tab="sdr" title="SDR Waterfall - Panadapter display from RSP2pro">SDR</button>
                    <button class="mobile-nav-item" data-tab="scanner" title="Band Scanner - Scan frequency ranges for active signals">SCANNER</button>
                    <button class="mobile-nav-item" data-tab="memory" title="Memory Channels - Store, recall and manage memory channels">MEMORY</button>
                    <button class="mobile-nav-item" data-tab="system" title="System - Memory channels and radio settings">SYSTEM</button>
                    <button class="mobile-nav-item" data-tab="config" title="Configuration - Serial port and interface settings">CONFIG</button>
                    <button class="mobile-nav-item" data-tab="status" title="Status - Real-time radio and server information">STATUS</button>
                    <button class="mobile-nav-item" data-tab="diag" title="Diagnostics - System health and troubleshooting">DIAG</button>
                </div>
            </div>
            
            <!-- VFO Control Tab -->
            <div class="tab-content active" id="vfo-ctrl">
                <div class="main-grid">
                    
                    <!-- VFO Control Panel -->
                    <div class="lcars-panel">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator blue"></div>
                            <div class="lcars-panel-title">VFO Control</div>
                        </div>
                        
                        <!-- VFO-A Display -->
                        <div class="frequency-display">
                            <div class="frequency-value" id="frequencyA">14.074.000</div>
                            <div class="frequency-label">VFO-A (MHz)</div>
                        </div>

                        <!-- Fine Tuning Controls -->
                        <div class="fine-tune-container">
                            <label>Fine Tuning Controls</label>
                            
                            <!-- Step Size Selector -->
                            <div class="step-selector">
                                <button class="step-btn" data-step="10" onclick="setTuningStep(10)" 
                                        title="10 Hz step increment - ultra-fine tuning">10 Hz</button>
                                <button class="step-btn" data-step="100" onclick="setTuningStep(100)" 
                                        title="100 Hz step increment - fine tuning">100 Hz</button>
                                <button class="step-btn active" data-step="1000" onclick="setTuningStep(1000)" 
                                        title="1 kHz step increment - standard tuning">1 kHz</button>
                                <button class="step-btn" data-step="10000" onclick="setTuningStep(10000)" 
                                        title="10 kHz step increment - band segment tuning">10 kHz</button>
                                <button class="step-btn" data-step="100000" onclick="setTuningStep(100000)" 
                                        title="100 kHz step increment - band hopping">100 kHz</button>
                                <button class="step-btn" data-step="1000000" onclick="setTuningStep(1000000)" 
                                        title="1 MHz step increment - major band changes">1 MHz</button>
                            </div>
                            
                            <!-- Nudge Controls -->
                            <div class="nudge-controls">
                                <button class="nudge-btn" onclick="nudgeFrequency('down')" 
                                        title="Decrease frequency by selected step size">▼</button>
                                <div class="step-display" id="stepDisplay">Step: 1 kHz</div>
                                <button class="nudge-btn" onclick="nudgeFrequency('up')" 
                                        title="Increase frequency by selected step size">▲</button>
                            </div>
                        </div>
                        
                        <!-- VFO Controls -->
                        <div class="vfo-controls">
                            <div class="vfo-knob">
                                <div class="knob-container">
                                    <div class="knob" id="tuneKnobA" data-vfo="a" 
                                         title="Rotate to tune VFO-A frequency (1° = 1kHz)"></div>
                                </div>
                                <div class="knob-label">TUNE-A</div>
                            </div>
                            <div class="vfo-knob">
                                <div class="knob-container">
                                    <div class="knob" id="tuneKnobB" data-vfo="b" 
                                         title="Rotate to tune VFO-B frequency (1° = 1kHz)"></div>
                                </div>
                                <div class="knob-label">TUNE-B</div>
                            </div>
                        </div>

                        <!-- Direct Frequency Entry -->
                        <div class="form-group">
                            <label>Direct Frequency Entry</label>
                            <div class="form-row">
                                <input type="number" id="directFreq" placeholder="14074000" 
                                       min="30000" max="470000000" title="Enter frequency in Hz (30 kHz - 470 MHz)">
                                <button class="btn primary" onclick="setDirectFrequency()" 
                                        title="Set VFO-A to entered frequency">SET FREQ</button>
                            </div>
                        </div>

                        <!-- VFO Operations -->
                        <div class="form-actions">
                            <button class="btn primary" onclick="swapVfo()" 
                                    title="Swap VFO-A and VFO-B frequencies">A⇄B SWAP</button>
                            <button class="btn primary" onclick="copyAtoB()" 
                                    title="Copy VFO-A frequency to VFO-B">A→B COPY</button>
                            <button id="autoTuneBtnVfo" class="btn" onclick="startAutoTune()" 
                                    style="background: var(--lcars-gold); color: #000; font-weight: bold;"
                                    title="Start antenna auto-tune (ATU)">⚡ AUTO TUNE</button>
                        </div>

                        <!-- VFO-B Display -->
                        <div class="frequency-display" style="margin-top: 1.5rem;">
                            <div class="frequency-value" id="frequencyB" style="font-size: 2rem;">14.074.000</div>
                            <div class="frequency-label">VFO-B (MHz)</div>
                        </div>
                    </div>

                    <!-- Mode & Band Control Panel -->
                    <div class="lcars-panel">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator green"></div>
                            <div class="lcars-panel-title">Mode & Band</div>
                        </div>
                        
                        <!-- Current Mode Display -->
                        <div class="form-group">
                            <label>Current Mode</label>
                            <div style="color: var(--lcars-gold); font-weight: bold; font-size: 1.2rem; text-align: center; padding: 0.5rem;" id="currentMode">DATA_USB</div>
                        </div>

                        <!-- Mode Selection -->
                        <div class="form-group">
                            <label>Mode Selection</label>
                            <div class="selector-grid">
                                <button class="selector-btn" onclick="setMode('LSB')" 
                                        title="Lower Side Band - Voice mode for HF bands below 10 MHz">LSB</button>
                                <button class="selector-btn" onclick="setMode('USB')" 
                                        title="Upper Side Band - Voice mode for HF bands above 10 MHz">USB</button>
                                <button class="selector-btn" onclick="setMode('CW')" 
                                        title="Continuous Wave - Morse code transmission mode">CW</button>
                                <button class="selector-btn" onclick="setMode('FM')" 
                                        title="Frequency Modulation - Standard VHF/UHF voice mode">FM</button>
                                <button class="selector-btn" onclick="setMode('AM')" 
                                        title="Amplitude Modulation - Legacy voice mode, aircraft band">AM</button>
                                <button class="selector-btn" onclick="setMode('DATA_USB')" 
                                        title="Digital data mode - FT8, FT4, RTTY, PSK31">FT8</button>
                                <button class="selector-btn" onclick="setMode('C4FM')" 
                                        title="Yaesu System Fusion digital voice mode">C4FM</button>
                                <button class="selector-btn" onclick="setMode('DATA_LSB')" 
                                        title="Digital data mode LSB - PSK31, OLIVIA">PSK</button>
                            </div>
                        </div>

                        <!-- Band Selection -->
                        <div class="form-group">
                            <label>Band Selection</label>
                            <div class="selector-grid">
                                <button class="selector-btn" onclick="setBand('160M')" 
                                        title="160 meters - 1.8-2.0 MHz (Top Band)">160M</button>
                                <button class="selector-btn" onclick="setBand('80M')" 
                                        title="80 meters - 3.5-4.0 MHz (Eighty)">80M</button>
                                <button class="selector-btn" onclick="setBand('40M')" 
                                        title="40 meters - 7.0-7.3 MHz (Forty)">40M</button>
                                <button class="selector-btn" onclick="setBand('30M')" 
                                        title="30 meters - 10.1-10.15 MHz (WARC band)">30M</button>
                                <button class="selector-btn" onclick="setBand('20M')" 
                                        title="20 meters - 14.0-14.35 MHz (Twenty - best DX band)">20M</button>
                                <button class="selector-btn" onclick="setBand('17M')" 
                                        title="17 meters - 18.068-18.168 MHz (WARC band)">17M</button>
                                <button class="selector-btn" onclick="setBand('15M')" 
                                        title="15 meters - 21.0-21.45 MHz (Fifteen)">15M</button>
                                <button class="selector-btn" onclick="setBand('12M')" 
                                        title="12 meters - 24.89-24.99 MHz (WARC band)">12M</button>
                                <button class="selector-btn" onclick="setBand('10M')" 
                                        title="10 meters - 28.0-29.7 MHz (Ten - FM repeaters)">10M</button>
                                <button class="selector-btn" onclick="setBand('VHF_6M')" 
                                        title="6 meters - 50-54 MHz (Magic Band VHF)">6M</button>
                                <button class="selector-btn" onclick="setBand('VHF_2M')" 
                                        title="2 meters - 144-148 MHz (VHF FM/SSB)">2M</button>
                                <button class="selector-btn" onclick="setBand('UHF_70CM')" 
                                        title="70 centimeters - 420-450 MHz (UHF)">70CM</button>
                            </div>
                        </div>

                        <!-- Quick FT8 Frequencies -->
                        <div class="form-group">
                            <label>FT8 Quick Access</label>
                            <div class="selector-grid">
                                <button class="selector-btn" onclick="setFT8Frequency(7074000)" 
                                        title="40m FT8 frequency - 7.074 MHz">40M FT8</button>
                                <button class="selector-btn" onclick="setFT8Frequency(14074000)" 
                                        title="20m FT8 frequency - 14.074 MHz (most popular)">20M FT8</button>
                                <button class="selector-btn" onclick="setFT8Frequency(21074000)" 
                                        title="15m FT8 frequency - 21.074 MHz">15M FT8</button>
                                <button class="selector-btn" onclick="setFT8Frequency(28074000)" 
                                        title="10m FT8 frequency - 28.074 MHz">10M FT8</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second Row -->
                <div class="main-grid">
                    
                    <!-- TX Control Panel -->
                    <div class="lcars-panel">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator orange"></div>
                            <div class="lcars-panel-title">TX Control</div>
                        </div>
                        
                        <div class="ptt-container">
                            <button class="ptt-button" id="pttButton" 
                                    onmousedown="pttPress()" 
                                    onmouseup="pttRelease()" 
                                    ontouchstart="pttPress()" 
                                    ontouchend="pttRelease()" 
                                    title="Push-to-Talk - Hold to transmit (Space key also works)">
                                PTT
                            </button>
                            
                            <button class="btn danger lockout-toggle" id="lockoutButton" onclick="toggleLockout()" 
                                    title="Enable/disable transmission lockout for safety">
                                🔒 TX LOCKOUT
                            </button>
                        </div>

                        <!-- TX Power Control -->
                        <div class="form-group">
                            <label>TX Power Control</label>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <input type="range" class="power-slider" id="powerSlider" min="5" max="100" value="50" 
                                       oninput="updatePower(this.value)" title="Adjust TX power output (5-100 watts)">
                                <span id="powerValue" style="min-width: 50px; text-align: right; color: var(--lcars-gold); font-weight: bold; font-size: 1.1rem;">50W</span>
                            </div>
                        </div>

                        <!-- Power Presets -->
                        <div class="form-group">
                            <label>Power Presets</label>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                                <button class="btn btn-small" onclick="setPowerPreset(5)" 
                                        title="Set TX power to 5 watts (QRP)">5W</button>
                                <button class="btn btn-small" onclick="setPowerPreset(25)" 
                                        title="Set TX power to 25 watts">25W</button>
                                <button class="btn btn-small" onclick="setPowerPreset(50)" 
                                        title="Set TX power to 50 watts (half power)">50W</button>
                                <button class="btn btn-small" onclick="setPowerPreset(100)" 
                                        title="Set TX power to 100 watts (maximum)">100W</button>
                            </div>
                        </div>

                        <!-- TX Status -->
                        <div class="status-grid">
                            <div class="status-item">
                                <div class="status-label">TX Status</div>
                                <div class="status-value" id="txStatus">RX</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">SWR</div>
                                <div class="status-value" id="swrValue">1.0:1</div>
                            </div>
                        </div>
                    </div>

                    <!-- Meters & Status Panel -->
                    <div class="lcars-panel">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator purple"></div>
                            <div class="lcars-panel-title">Meters & Status</div>
                        </div>
                        
                        <!-- S-Meter -->
                        <div class="meter">
                            <div class="meter-label">
                                <span>S-Meter</span>
                                <span class="meter-value" id="sMeterValue">S0</span>
                            </div>
                            <div class="meter-bar">
                                <div class="meter-fill" id="sMeterBar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <!-- Status Grid -->
                        <div class="status-grid">
                            <div class="status-item">
                                <div class="status-label">Squelch</div>
                                <div class="status-value" id="squelchStatus">CLOSED</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Mode</div>
                                <div class="status-value" id="statusMode">USB</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Power Out</div>
                                <div class="status-value" id="powerOut">0W</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Lockout</div>
                                <div class="status-value" id="lockoutStatus">OFF</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audio Integration Panel -->
                <div class="lcars-panel full-width">
                    <div class="lcars-panel-header">
                        <div class="lcars-panel-indicator green"></div>
                        <div class="lcars-panel-title">🎧 Audio Integration (Linux)</div>
                    </div>
                    <p style="color: var(--lcars-peach); line-height: 1.6; margin-bottom: 1rem;">
                        The FT-991A has a built-in USB sound card. For digital modes (FT8, PSK31, etc.) and audio monitoring:
                    </p>
                    <div class="audio-code-block">
                        <div class="audio-code-comment"># List audio devices:</div>
                        <div>pactl list short sources | grep -i yaesu</div>
                        <div>pactl list short sinks | grep -i yaesu</div>
                        <br>
                        <div class="audio-code-comment"># Route audio for WSJT-X (FT8):</div>
                        <div>pavucontrol  # Use GUI to select FT-991A as input/output</div>
                        <br>
                        <div class="audio-code-comment"># Command line routing:</div>
                        <div>pactl set-default-source "alsa_input.usb-YAESU_FT-991A..."</div>
                        <div>pactl set-default-sink "alsa_output.usb-YAESU_FT-991A..."</div>
                    </div>
                </div>
            </div>

            <!-- AUDIO WATERFALL Tab -->
            <div class="tab-content" id="audio">
                <div class="lcars-panel full-width">
                    <div class="lcars-panel-header">
                        <div class="lcars-panel-indicator green"></div>
                        <div class="lcars-panel-title">📡 Audio Waterfall Display</div>
                    </div>

                    <!-- ═══ INLINE TUNER STRIP ═══ -->
                    <div class="lcars-panel full-width" id="waterfallTuner">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator gold"></div>
                            <div class="lcars-panel-title">⚡ VFO TUNER</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; padding: 0.5rem 0;">
                            <!-- Frequency Display (clickable to edit) -->
                            <div style="flex: 0 0 auto; text-align: center;">
                                <div id="tunerFreqDisplay" style="font-family: 'Antonio', monospace; font-size: 2.2rem; color: var(--lcars-gold); letter-spacing: 2px; cursor: pointer; user-select: none; text-shadow: 0 0 10px rgba(255,168,0,0.4);" 
                                     onclick="showFreqInput()" title="Click to enter frequency directly">
                                    14.250.000
                                </div>
                                <div style="font-size: 0.7rem; color: var(--lcars-orange); letter-spacing: 3px;">MHz</div>
                                <input type="text" id="tunerFreqInput" style="display:none; font-family:'Antonio',monospace; font-size:1.8rem; background:rgba(0,0,0,0.8); color:var(--lcars-gold); border:2px solid var(--lcars-orange); border-radius:var(--radius-sm); text-align:center; width:12ch; padding:0.2rem;"
                                       placeholder="14.250.000" title="Enter frequency in MHz (e.g. 14.250.000)" 
                                       onkeydown="if(event.key==='Enter')submitTunerFreq(); if(event.key==='Escape')hideTunerFreqInput();"
                                       onblur="hideTunerFreqInput()">
                            </div>

                            <!-- Mode badge -->
                            <div id="tunerModeBadge" style="flex: 0 0 auto; background: var(--lcars-blue); color: #000; font-weight: 900; font-size: 0.9rem; padding: 0.3rem 0.8rem; border-radius: var(--radius-sm); letter-spacing: 2px;" title="Current operating mode">
                                USB
                            </div>

                            <!-- Step size selector -->
                            <div style="flex: 1 1 auto; display: flex; align-items: center; gap: 0.3rem; flex-wrap: wrap;">
                                <span style="color: var(--lcars-peach); font-size: 0.7rem; margin-right: 0.3rem;">STEP:</span>
                                <button class="selector-btn" onclick="setTunerStep(10, this)" title="10 Hz tuning step">10</button>
                                <button class="selector-btn active" onclick="setTunerStep(100, this)" title="100 Hz tuning step">100</button>
                                <button class="selector-btn" onclick="setTunerStep(1000, this)" title="1 kHz tuning step">1k</button>
                                <button class="selector-btn" onclick="setTunerStep(5000, this)" title="5 kHz tuning step">5k</button>
                                <button class="selector-btn" onclick="setTunerStep(10000, this)" title="10 kHz tuning step">10k</button>
                                <button class="selector-btn" onclick="setTunerStep(100000, this)" title="100 kHz tuning step">100k</button>
                                <button class="selector-btn" onclick="setTunerStep(1000000, this)" title="1 MHz tuning step">1M</button>
                            </div>

                            <!-- Tune Up/Down buttons -->
                            <div style="flex: 0 0 auto; display: flex; gap: 0.4rem;">
                                <button class="btn" onclick="tuneDown()" style="font-size: 1.4rem; padding: 0.3rem 1rem; background: var(--lcars-lavender);" title="Tune down by selected step size">◀ DN</button>
                                <button class="btn" onclick="tuneUp()" style="font-size: 1.4rem; padding: 0.3rem 1rem; background: var(--lcars-lavender);" title="Tune up by selected step size">UP ▶</button>
                                <button id="autoTuneBtn" class="btn" onclick="startAutoTune()" style="font-size: 1.2rem; padding: 0.3rem 1rem; background: var(--lcars-gold); color: #000; font-weight: bold; margin-left: 1rem;" title="Start antenna auto-tune (ATU)">⚡ AUTO TUNE</button>
                            </div>

                            <!-- S-meter mini bar -->
                            <div style="flex: 0 0 120px;">
                                <div style="font-size: 0.6rem; color: var(--lcars-peach); margin-bottom: 2px;">S-METER</div>
                                <div style="background: rgba(0,0,0,0.6); border: 1px solid var(--lcars-orange); border-radius: 3px; height: 14px; overflow: hidden;">
                                    <div id="tunerSmeterBar" style="height: 100%; width: 40%; background: linear-gradient(90deg, var(--lcars-green), var(--lcars-gold), var(--lcars-red)); transition: width 0.3s;" title="Signal strength meter"></div>
                                </div>
                                <div id="tunerSmeterVal" style="font-size: 0.65rem; color: var(--lcars-gold); text-align: right;">S5</div>
                            </div>
                        </div>
                    </div>

                    <!-- Waterfall Display -->
                    <div class="lcars-panel full-width">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator blue"></div>
                            <div class="lcars-panel-title">FFT Spectrum Waterfall</div>
                        </div>
                        
                        <!-- Waterfall Canvas Container -->
                        <div style="background: rgba(0, 0, 0, 0.8); border: 2px solid var(--lcars-orange); border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 1rem; position: relative;">
                            <canvas id="waterfallCanvas" width="800" height="400" 
                                    style="width: 100%; height: 400px; background: #000; border-radius: var(--radius-sm); display: block;"
                                    title="Real-time audio spectrum waterfall display">
                            </canvas>
                            
                            <!-- Frequency overlay -->
                            <div id="frequencyOverlay" style="position: absolute; top: 1rem; left: 1rem; color: var(--lcars-gold); font-weight: 700; font-size: 0.9rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); pointer-events: none;">
                                <div id="currentFreqDisplay">14.074.000 MHz</div>
                                <div id="currentModeDisplay" style="font-size: 0.8rem; color: var(--lcars-orange);">DATA_USB</div>
                            </div>
                            
                            <!-- Status indicator -->
                            <div id="waterfallStatus" style="position: absolute; top: 1rem; right: 1rem; color: var(--lcars-red); font-weight: 700; font-size: 0.8rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                                ● OFFLINE
                            </div>
                        </div>

                        <!-- Waterfall Controls -->
                        <div class="main-grid">
                            <div class="lcars-panel">
                                <div class="lcars-panel-header">
                                    <div class="lcars-panel-indicator orange"></div>
                                    <div class="lcars-panel-title">Waterfall Controls</div>
                                </div>

                                <div class="form-group" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button class="btn success" id="waterfallPlayButton" onclick="toggleWaterfall()" 
                                            title="Start/stop audio stream and waterfall display">▶ START WATERFALL</button>
                                    <button class="btn" id="listenButton" onclick="toggleListen()" 
                                            style="background: var(--lcars-blue);"
                                            title="Listen to radio audio through your browser speakers">🔇 LISTEN OFF</button>
                                </div>
                                <div class="form-group">
                                    <label>🔊 Volume</label>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <input type="range" class="volume-slider" id="audioVolumeSlider" min="0" max="100" value="50"
                                               oninput="setAudioVolume(this.value)" title="Adjust radio audio volume">
                                        <span id="volumeValue" style="min-width: 40px; text-align: right; color: var(--lcars-gold); font-weight: bold;">50%</span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Frequency Zoom</label>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <input type="range" class="power-slider" id="zoomSlider" min="1" max="10" value="1" step="0.5"
                                               oninput="updateZoom(this.value)" title="Adjust frequency zoom level">
                                        <span id="zoomValue" style="min-width: 50px; text-align: right; color: var(--lcars-gold); font-weight: bold; font-size: 1rem;">1x</span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Scroll Speed</label>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <input type="range" class="volume-slider" id="speedSlider" min="1" max="20" value="5" 
                                               oninput="updateSpeed(this.value)" title="Adjust waterfall scroll speed">
                                        <span id="speedValue" style="min-width: 50px; text-align: right; color: var(--lcars-green); font-weight: bold; font-size: 1rem;">5</span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>FFT Resolution</label>
                                    <div class="selector-grid">
                                        <button class="selector-btn" onclick="setFFTSize(256)" title="FFT resolution - less detail, faster">256</button>
                                        <button class="selector-btn" onclick="setFFTSize(512)" title="FFT resolution - balanced">512</button>
                                        <button class="selector-btn active" onclick="setFFTSize(1024)" title="FFT resolution - more detail">1024</button>
                                        <button class="selector-btn" onclick="setFFTSize(2048)" title="FFT resolution - highest detail, more CPU">2048</button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Canvas Height</label>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <input type="range" class="power-slider" id="heightSlider" min="200" max="800" value="400" step="50"
                                               oninput="updateCanvasHeight(this.value)" title="Adjust waterfall display height">
                                        <span id="heightValue" style="min-width: 60px; text-align: right; color: var(--lcars-gold); font-weight: bold; font-size: 1rem;">400px</span>
                                    </div>
                                </div>
                            </div>

                            <div class="lcars-panel">
                                <div class="lcars-panel-header">
                                    <div class="lcars-panel-indicator purple"></div>
                                    <div class="lcars-panel-title">Display Options</div>
                                </div>

                                <div class="form-group">
                                    <label>Color Palette</label>
                                    <div class="selector-grid">
                                        <button class="selector-btn active" onclick="setColorPalette('radio')" title="FT-991A radio-style heat map (blue→cyan→green→yellow→red)">RADIO</button>
                                        <button class="selector-btn" onclick="setColorPalette('amber')" title="LCARS amber color scheme">AMBER</button>
                                        <button class="selector-btn" onclick="setColorPalette('blue')" title="Blue color scheme">BLUE</button>
                                        <button class="selector-btn" onclick="setColorPalette('green')" title="Green color scheme">GREEN</button>
                                        <button class="selector-btn" onclick="setColorPalette('gray')" title="Grayscale color scheme">GRAY</button>
                                    </div>
                                </div>

                                <div class="status-grid">
                                    <div class="status-item">
                                        <div class="status-label">Stream Status</div>
                                        <div class="status-value" id="streamStatus">STOPPED</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">Sample Rate</div>
                                        <div class="status-value" id="audioSampleRate">48 kHz</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">FFT Size</div>
                                        <div class="status-value" id="fftSizeDisplay">1024</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">Bandwidth</div>
                                        <div class="status-value" id="bandwidthDisplay">24 kHz</div>
                                    </div>
                                </div>

                                <div class="diagnostic-item">
                                    <h4>Audio Level</h4>
                                    <div class="meter">
                                        <div class="meter-label">
                                            <span>Peak Level</span>
                                            <span class="meter-value" id="audioLevelValue">-∞ dB</span>
                                        </div>
                                        <div class="meter-bar">
                                            <div class="meter-fill" id="audioLevelBar" style="width: 0%;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lcars-panel full-width">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator green"></div>
                                <div class="lcars-panel-title">Audio Device Status</div>
                            </div>

                            <div class="status-grid">
                                <div class="status-item">
                                    <div class="status-label">CODEC Status</div>
                                    <div class="status-value" id="codecStatus">DETECTING...</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Device</div>
                                    <div class="status-value" id="audioDevice">PCM2903B</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Format</div>
                                    <div class="status-value" id="audioFormat">S16_LE</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Channels</div>
                                    <div class="status-value" id="audioChannels">1 (Mono)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- S-Meter History Graph -->
                    <div class="lcars-panel full-width">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator gold"></div>
                            <div class="lcars-panel-title">📈 S-Meter History</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.8); border: 2px solid var(--lcars-gold); border-radius: var(--radius-sm); padding: 0.5rem; position: relative;">
                            <canvas id="smeterCanvas" width="800" height="150" 
                                    style="width: 100%; height: 150px; background: #000; border-radius: var(--radius-sm); display: block;"
                                    title="Real-time S-meter signal strength history (last 120 readings)">
                            </canvas>
                            <div style="position: absolute; top: 0.5rem; right: 0.8rem; color: var(--lcars-peach); font-size: 0.65rem; pointer-events: none;">
                                <span id="smeterPeak" title="Peak signal strength">PEAK: S0</span> · 
                                <span id="smeterAvg" title="Average signal strength">AVG: S0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SDR WATERFALL Tab -->
            <div class="tab-content" id="sdr">
                <div class="lcars-panel full-width">
                    <div class="lcars-panel-header">
                        <div class="lcars-panel-indicator blue"></div>
                        <div class="lcars-panel-title">📡 SDR Panadapter (RSP2pro)</div>
                    </div>

                    <!-- SDR VFO Tuner Strip -->
                    <div class="lcars-panel full-width" id="sdrTuner">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator gold"></div>
                            <div class="lcars-panel-title">⚡ SDR VFO TUNER</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; padding: 0.5rem 0;">
                            <!-- Frequency Display (clickable to edit) -->
                            <div style="flex: 0 0 auto; text-align: center;">
                                <div id="sdrFreqDisplay" style="font-family: 'Antonio', monospace; font-size: 2.2rem; color: var(--lcars-gold); letter-spacing: 2px; cursor: pointer; user-select: none; text-shadow: 0 0 10px rgba(255,168,0,0.4);" 
                                     onclick="showSDRFreqInput()" title="Click to enter frequency directly - centers SDR on this frequency">
                                    14.250.000
                                </div>
                                <div style="font-size: 0.7rem; color: var(--lcars-orange); letter-spacing: 3px;">MHz (CENTER)</div>
                                <input type="text" id="sdrFreqInput" style="display:none; font-family:'Antonio',monospace; font-size:1.8rem; background:rgba(0,0,0,0.8); color:var(--lcars-gold); border:2px solid var(--lcars-orange); border-radius:var(--radius-sm); text-align:center; width:12ch; padding:0.2rem;"
                                       placeholder="14.250.000" title="Enter center frequency in MHz (e.g. 14.250.000)" 
                                       onkeydown="if(event.key==='Enter')submitSDRFreq(); if(event.key==='Escape')hideSDRFreqInput();"
                                       onblur="hideSDRFreqInput()">
                            </div>

                            <!-- Mode badge -->
                            <div id="sdrModeBadge" style="flex: 0 0 auto; background: var(--lcars-blue); color: #000; font-weight: 900; font-size: 0.9rem; padding: 0.3rem 0.8rem; border-radius: var(--radius-sm); letter-spacing: 2px;" title="Current radio operating mode">
                                USB
                            </div>

                            <!-- Bandwidth selector -->
                            <div style="flex: 1 1 auto; display: flex; align-items: center; gap: 0.3rem; flex-wrap: wrap;">
                                <span style="color: var(--lcars-peach); font-size: 0.7rem; margin-right: 0.3rem;">BANDWIDTH:</span>
                                <button class="selector-btn" onclick="setSDRBandwidth(500000, this)" title="500 kHz SDR bandwidth">500k</button>
                                <button class="selector-btn" onclick="setSDRBandwidth(1000000, this)" title="1 MHz SDR bandwidth">1M</button>
                                <button class="selector-btn active" onclick="setSDRBandwidth(2000000, this)" title="2 MHz SDR bandwidth">2M</button>
                                <button class="selector-btn" onclick="setSDRBandwidth(5000000, this)" title="5 MHz SDR bandwidth">5M</button>
                                <button class="selector-btn" onclick="setSDRBandwidth(10000000, this)" title="10 MHz SDR bandwidth">10M</button>
                            </div>

                            <!-- Click-to-tune indicator -->
                            <div style="flex: 0 0 auto;">
                                <div style="font-size: 0.6rem; color: var(--lcars-peach); text-align: center; margin-bottom: 2px;">CLICK WATERFALL</div>
                                <div style="font-size: 0.6rem; color: var(--lcars-gold); text-align: center;">TO TUNE RADIO</div>
                            </div>
                        </div>
                    </div>

                    <!-- SDR Waterfall Display -->
                    <div class="lcars-panel full-width">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator blue"></div>
                            <div class="lcars-panel-title">RF Spectrum Waterfall</div>
                        </div>
                        
                        <!-- Waterfall Canvas Container -->
                        <div style="background: rgba(0, 0, 0, 0.8); border: 2px solid var(--lcars-orange); border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 1rem; position: relative;">
                            <canvas id="sdrWaterfallCanvas" width="800" height="400" 
                                    style="width: 100%; height: 400px; background: #000; border-radius: var(--radius-sm); display: block; cursor: crosshair;"
                                    title="SDR panadapter waterfall - click to tune radio to frequency"
                                    onclick="handleSDRClick(event)">
                            </canvas>
                            
                            <!-- Frequency axis labels -->
                            <div id="sdrFreqAxis" style="position: absolute; bottom: 1rem; left: 1rem; right: 1rem; height: 20px; pointer-events: none;">
                                <!-- Frequency labels will be inserted here by JavaScript -->
                            </div>
                            
                            <!-- Radio frequency indicator line -->
                            <div id="sdrRadioFreqLine" style="position: absolute; top: 1rem; bottom: 3rem; width: 2px; background: var(--lcars-red); pointer-events: none; display: none;">
                                <div style="position: absolute; top: -20px; left: -30px; width: 60px; text-align: center; font-size: 0.7rem; color: var(--lcars-red); font-weight: bold;">RADIO</div>
                            </div>
                            
                            <!-- Status indicator -->
                            <div id="sdrWaterfallStatus" style="position: absolute; top: 1rem; right: 1rem; color: var(--lcars-red); font-weight: 700; font-size: 0.8rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                                ● SDR OFFLINE
                            </div>
                        </div>

                        <!-- SDR Controls -->
                        <div class="main-grid">
                            <div class="lcars-panel">
                                <div class="lcars-panel-header">
                                    <div class="lcars-panel-indicator orange"></div>
                                    <div class="lcars-panel-title">SDR Controls</div>
                                </div>

                                <div class="form-group" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button class="btn success" id="sdrStartButton" onclick="toggleSDRWaterfall()" 
                                            title="Start/stop SDR stream and waterfall display">▶ START SDR</button>
                                </div>

                                <div class="form-group">
                                    <label>FFT Resolution</label>
                                    <div class="selector-grid">
                                        <button class="selector-btn" onclick="setSDRFFTSize(256, this)" title="FFT resolution - less detail, faster">256</button>
                                        <button class="selector-btn" onclick="setSDRFFTSize(512, this)" title="FFT resolution - balanced">512</button>
                                        <button class="selector-btn active" onclick="setSDRFFTSize(1024, this)" title="FFT resolution - more detail">1024</button>
                                        <button class="selector-btn" onclick="setSDRFFTSize(2048, this)" title="FFT resolution - highest detail, more CPU">2048</button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Waterfall Speed</label>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <input type="range" class="volume-slider" id="sdrSpeedSlider" min="1" max="20" value="10" 
                                               oninput="updateSDRSpeed(this.value)" title="Adjust waterfall scroll speed">
                                        <span id="sdrSpeedValue" style="min-width: 50px; text-align: right; color: var(--lcars-green); font-weight: bold; font-size: 1rem;">10</span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Canvas Height</label>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <input type="range" class="power-slider" id="sdrHeightSlider" min="200" max="800" value="400" step="50"
                                               oninput="updateSDRCanvasHeight(this.value)" title="Adjust waterfall display height">
                                        <span id="sdrHeightValue" style="min-width: 60px; text-align: right; color: var(--lcars-gold); font-weight: bold; font-size: 1rem;">400px</span>
                                    </div>
                                </div>
                            </div>

                            <div class="lcars-panel">
                                <div class="lcars-panel-header">
                                    <div class="lcars-panel-indicator purple"></div>
                                    <div class="lcars-panel-title">Display Options</div>
                                </div>

                                <div class="form-group">
                                    <label>Color Palette</label>
                                    <div class="selector-grid">
                                        <button class="selector-btn active" onclick="setSDRColorPalette('radio', this)" title="FT-991A radio-style heat map (blue→cyan→green→yellow→red)">RADIO</button>
                                        <button class="selector-btn" onclick="setSDRColorPalette('amber', this)" title="LCARS amber color scheme">AMBER</button>
                                        <button class="selector-btn" onclick="setSDRColorPalette('blue', this)" title="Blue color scheme">BLUE</button>
                                        <button class="selector-btn" onclick="setSDRColorPalette('green', this)" title="Green color scheme">GREEN</button>
                                        <button class="selector-btn" onclick="setSDRColorPalette('gray', this)" title="Grayscale color scheme">GRAY</button>
                                    </div>
                                </div>

                                <div class="status-grid">
                                    <div class="status-item">
                                        <div class="status-label">SDR Status</div>
                                        <div class="status-value" id="sdrStreamStatus">STOPPED</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">Bandwidth</div>
                                        <div class="status-value" id="sdrBandwidthDisplay">2 MHz</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">FFT Size</div>
                                        <div class="status-value" id="sdrFFTSizeDisplay">1024</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">Frame Rate</div>
                                        <div class="status-value" id="sdrFrameRateDisplay">~10 fps</div>
                                    </div>
                                </div>

                                <div class="diagnostic-item">
                                    <h4>Signal Level</h4>
                                    <div class="meter">
                                        <div class="meter-label">
                                            <span>Peak Signal</span>
                                            <span class="meter-value" id="sdrSignalLevelValue">-∞ dB</span>
                                        </div>
                                        <div class="meter-bar">
                                            <div class="meter-fill" id="sdrSignalLevelBar" style="width: 0%;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lcars-panel full-width">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator green"></div>
                                <div class="lcars-panel-title">SDRplay RSP2pro Status</div>
                            </div>

                            <div class="status-grid">
                                <div class="status-item">
                                    <div class="status-label">Device Status</div>
                                    <div class="status-value" id="sdrDeviceStatus">DETECTING...</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Serial</div>
                                    <div class="status-value" id="sdrSerial">1717050C11</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Driver</div>
                                    <div class="status-value" id="sdrDriver">SoapySDR</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Connection</div>
                                    <div class="status-value" id="sdrConnection">USB</div>
                                </div>
                            </div>

                            <!-- SoapySDR Code Block -->
                            <div class="audio-code-block" style="font-size: 0.85rem;">
                                <div class="audio-code-comment"># SDRplay RSP2pro SoapySDR Commands:</div>
                                <div><span style="color: var(--lcars-gold);">SoapySDRUtil --find</span>  # List all SDR devices</div>
                                <div><span style="color: var(--lcars-gold);">SoapySDRUtil --probe="driver=sdrplay"</span>  # Probe RSP2pro</div>
                                <br>
                                <div class="audio-code-comment"># Python SoapySDR (backend uses this):</div>
                                <div>import SoapySDR</div>
                                <div>sdr = SoapySDR.Device(dict(driver="sdrplay"))</div>
                                <div>sdr.setSampleRate(SoapySDR.SOAPY_SDR_RX, 0, 2000000)  # 2 MHz</div>
                                <div>sdr.setFrequency(SoapySDR.SOAPY_SDR_RX, 0, 14074000)  # 20m FT8</div>
                                <br>
                                <div class="audio-code-comment"># Gain settings (IF/RF):</div>
                                <div style="color: var(--lcars-peach); font-size: 0.8rem;">IFGR: 20-59 dB (IF Gain) | RFGR: 0-9 (RF Gain)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MEMORY Tab -->
            <div class="tab-content" id="memory">
                <div class="lcars-panel full-width">
                    <div class="lcars-panel-header">
                        <div class="lcars-panel-indicator gold"></div>
                        <div class="lcars-panel-title">📻 Memory Channel Manager</div>
                    </div>

                    <div class="main-grid">
                        <!-- Memory Channel List -->
                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator blue"></div>
                                <div class="lcars-panel-title">Memory Channels (001-099)</div>
                            </div>

                            <div class="form-group">
                                <div class="form-actions">
                                    <button class="btn success" id="scanMemoryBtn" onclick="scanMemoryChannels()" 
                                            title="Scan all memory channels from radio (reads MR001; through MR099;)">SCAN ALL MEMORIES</button>
                                    <button class="btn" onclick="refreshMemoryDisplay()" 
                                            title="Refresh memory channel display">REFRESH</button>
                                </div>
                            </div>

                            <div class="memory-list" id="memoryChannelList" style="max-height: 500px; overflow-y: auto;">
                                <!-- Memory channels will be populated here -->
                                <div class="placeholder-message" id="memoryLoadingMsg">
                                    Click "SCAN ALL MEMORIES" to load channels from radio
                                </div>
                            </div>

                            <div class="status-grid" style="margin-top: 1rem;">
                                <div class="status-item">
                                    <div class="status-label">Total Channels</div>
                                    <div class="status-value" id="totalChannels">99</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Programmed</div>
                                    <div class="status-value" id="programmedChannels">-</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Current Memory</div>
                                    <div class="status-value active" id="currentMemoryChannel">-</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Last Operation</div>
                                    <div class="status-value" id="lastMemoryOp">None</div>
                                </div>
                            </div>
                        </div>

                        <!-- Memory Operations -->
                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator orange"></div>
                                <div class="lcars-panel-title">Memory Operations</div>
                            </div>

                            <!-- Quick Recall -->
                            <div class="form-group">
                                <label>Quick Memory Recall</label>
                                <div class="form-row">
                                    <input type="number" id="recallChannelNum" placeholder="001" min="1" max="99" 
                                           title="Memory channel number (001-099)">
                                    <button class="btn primary" onclick="recallMemoryChannel()" 
                                            title="Recall memory channel to VFO-A (MC command)">RECALL</button>
                                </div>
                            </div>

                            <!-- Store Current VFO -->
                            <div class="form-group">
                                <label>Store Current VFO-A to Memory</label>
                                <div class="form-row">
                                    <input type="number" id="storeChannelNum" placeholder="001" min="1" max="99" 
                                           title="Target memory channel number (001-099)">
                                    <button class="btn success" onclick="storeToMemoryChannel()" 
                                            title="Store current VFO-A frequency and mode to memory channel (MW command)">STORE</button>
                                </div>
                            </div>

                            <!-- Current VFO Info -->
                            <div class="diagnostic-item">
                                <h4>Current VFO-A Status</h4>
                                <div class="status-grid">
                                    <div class="status-item">
                                        <div class="status-label">Frequency</div>
                                        <div class="status-value" id="currentVfoFreq">14.074.000</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">Mode</div>
                                        <div class="status-value" id="currentVfoMode">DATA_USB</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Memory Management -->
                            <div class="form-group">
                                <label>Memory Management</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <button class="btn btn-small danger" onclick="clearMemoryChannel()" 
                                            title="Clear/delete selected memory channel">CLEAR CHANNEL</button>
                                    <button class="btn btn-small" onclick="copyMemoryChannel()" 
                                            title="Copy one memory channel to another">COPY CHANNEL</button>
                                </div>
                            </div>

                            <!-- Memory Labels -->
                            <div class="form-group">
                                <label>Memory Label (Future Feature)</label>
                                <input type="text" id="memoryLabel" placeholder="Label (MT command - future)" 
                                       maxlength="8" disabled
                                       title="Memory channel label - MT command implementation planned">
                            </div>
                        </div>
                    </div>

                    <!-- Memory Channel Details -->
                    <div class="lcars-panel full-width" id="memoryDetailsPanel" style="display: none;">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator purple"></div>
                            <div class="lcars-panel-title">Memory Channel Details</div>
                        </div>

                        <div class="main-grid">
                            <div class="diagnostic-item">
                                <h4>Channel <span id="detailChannelNum">001</span> Information</h4>
                                <div class="status-grid">
                                    <div class="status-item">
                                        <div class="status-label">Frequency</div>
                                        <div class="status-value" id="detailFrequency">14.074.000 MHz</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">Mode</div>
                                        <div class="status-value" id="detailMode">DATA_USB</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">CTCSS</div>
                                        <div class="status-value" id="detailCtcss">OFF</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">Label</div>
                                        <div class="status-value" id="detailLabel">-</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button class="btn primary" onclick="recallDetailedChannel()" 
                                        title="Recall this memory channel to VFO-A">RECALL</button>
                                <button class="btn success" onclick="updateDetailedChannel()" 
                                        title="Update this channel with current VFO-A">UPDATE</button>
                                <button class="btn danger" onclick="deleteDetailedChannel()" 
                                        title="Delete this memory channel">DELETE</button>
                                <button class="btn" onclick="hideMemoryDetails()" 
                                        title="Close details panel">CLOSE</button>
                            </div>
                        </div>
                    </div>

                    <!-- CAT Command Reference -->
                    <div class="lcars-panel full-width">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator green"></div>
                            <div class="lcars-panel-title">🛠️ FT-991A Memory CAT Commands</div>
                        </div>
                        
                        <div class="audio-code-block" style="font-size: 0.85rem;">
                            <div class="audio-code-comment"># Memory operations (RX safe - no transmitting):</div>
                            <div><span style="color: var(--lcars-gold);">MC001;</span>  # Memory Channel recall - tunes VFO to memory 001</div>
                            <div><span style="color: var(--lcars-gold);">MR001;</span>  # Memory Read - reads memory 001 data</div>
                            <div><span style="color: var(--lcars-gold);">MW001;</span>  # Memory Write - stores current VFO to memory 001</div>
                            <br>
                            <div class="audio-code-comment"># Memory response format (MR command):</div>
                            <div>MR001+14074000000100200000000000000000000000000;</div>
                            <div style="color: var(--lcars-peach); font-size: 0.8rem;">      ↑channel ↑frequency ↑mode ↑other data</div>
                            <br>
                            <div class="audio-code-comment"># Future: Memory tag (label) support:</div>
                            <div><span style="color: var(--lcars-lilac);">MT001;</span>  # Read memory tag for channel 001 (8 chars max)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SCANNER Tab -->
            <div class="tab-content" id="scanner">
                <div class="lcars-panel full-width">
                    <div class="lcars-panel-header">
                        <div class="lcars-panel-indicator orange"></div>
                        <div class="lcars-panel-title">📡 Band Scanner</div>
                    </div>

                    <div class="main-grid">
                        <!-- Scanner Controls -->
                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator blue"></div>
                                <div class="lcars-panel-title">Scanner Controls</div>
                            </div>

                            <!-- Preset Band Ranges -->
                            <div class="form-group">
                                <label>Preset Band Ranges</label>
                                <div class="selector-grid">
                                    <button class="selector-btn" onclick="selectBandRange(3500000, 4000000)" 
                                            title="80 meters band - 3.5-4.0 MHz">80M</button>
                                    <button class="selector-btn" onclick="selectBandRange(7000000, 7300000)" 
                                            title="40 meters band - 7.0-7.3 MHz">40M</button>
                                    <button class="selector-btn" onclick="selectBandRange(14000000, 14350000)" 
                                            title="20 meters band - 14.0-14.35 MHz">20M</button>
                                    <button class="selector-btn" onclick="selectBandRange(21000000, 21450000)" 
                                            title="15 meters band - 21.0-21.45 MHz">15M</button>
                                    <button class="selector-btn" onclick="selectBandRange(28000000, 29700000)" 
                                            title="10 meters band - 28.0-29.7 MHz">10M</button>
                                    <button class="selector-btn" onclick="selectBandRange(144000000, 148000000)" 
                                            title="2 meters band - 144.0-148.0 MHz">2M</button>
                                    <button class="selector-btn" onclick="selectBandRange(420000000, 450000000)" 
                                            title="70 centimeters band - 420.0-450.0 MHz">70CM</button>
                                </div>
                            </div>

                            <!-- Custom Range Entry -->
                            <div class="form-group">
                                <label>Custom Frequency Range</label>
                                <div class="form-row">
                                    <input type="number" id="scanStartFreq" placeholder="Start (Hz)" 
                                           min="30000" max="470000000" title="Scan start frequency in Hz">
                                    <input type="number" id="scanEndFreq" placeholder="End (Hz)" 
                                           min="30000" max="470000000" title="Scan end frequency in Hz">
                                </div>
                            </div>

                            <!-- Step Size Selector -->
                            <div class="form-group">
                                <label>Step Size</label>
                                <div class="selector-grid">
                                    <button class="selector-btn" data-step="1000" onclick="setScanStep(1000)" 
                                            title="1 kHz step size">1kHz</button>
                                    <button class="selector-btn active" data-step="5000" onclick="setScanStep(5000)" 
                                            title="5 kHz step size - good balance">5kHz</button>
                                    <button class="selector-btn" data-step="10000" onclick="setScanStep(10000)" 
                                            title="10 kHz step size">10kHz</button>
                                    <button class="selector-btn" data-step="25000" onclick="setScanStep(25000)" 
                                            title="25 kHz step size - faster scan">25kHz</button>
                                    <button class="selector-btn" data-step="100000" onclick="setScanStep(100000)" 
                                            title="100 kHz step size - very fast">100kHz</button>
                                </div>
                            </div>

                            <!-- Squelch Threshold -->
                            <div class="form-group">
                                <label>Squelch Threshold (S-meter)</label>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <input type="range" class="volume-slider" id="squelchThreshold" min="0" max="255" value="50" 
                                           oninput="updateSquelchThreshold(this.value)" title="S-meter threshold for 'active' signals">
                                    <span id="squelchValue" style="min-width: 50px; text-align: right; color: var(--lcars-green); font-weight: bold; font-size: 1rem;">S3</span>
                                </div>
                            </div>

                            <!-- Scan Control -->
                            <div class="form-group">
                                <button class="btn primary" id="scanButton" onclick="toggleScan()" 
                                        title="Start/stop frequency scanning">▶ START SCAN</button>
                            </div>

                            <!-- Scan Progress -->
                            <div class="meter">
                                <div class="meter-label">
                                    <span>Scan Progress</span>
                                    <span class="meter-value" id="scanProgress">0%</span>
                                </div>
                                <div class="meter-bar">
                                    <div class="meter-fill" id="scanProgressBar" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Scan Status -->
                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator green"></div>
                                <div class="lcars-panel-title">Scan Status</div>
                            </div>

                            <div class="status-grid">
                                <div class="status-item">
                                    <div class="status-label">Status</div>
                                    <div class="status-value" id="scanStatus">STOPPED</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Current Freq</div>
                                    <div class="status-value" id="scanCurrentFreq">---</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Active Signals</div>
                                    <div class="status-value" id="scanActiveCount">0</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Scanned</div>
                                    <div class="status-value" id="scanCount">0</div>
                                </div>
                            </div>

                            <div class="diagnostic-item">
                                <h4>Scan Parameters</h4>
                                <div style="font-family: monospace; font-size: 0.85rem; color: var(--lcars-text);">
                                    <div>Range: <span id="scanRangeDisplay">Not set</span></div>
                                    <div>Step: <span id="scanStepDisplay">5 kHz</span></div>
                                    <div>Threshold: <span id="scanThresholdDisplay">S3</span></div>
                                    <div>ETA: <span id="scanETA">---</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scan Results Table -->
                    <div class="lcars-panel full-width">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator purple"></div>
                            <div class="lcars-panel-title">Scan Results</div>
                        </div>

                        <div style="background: rgba(0, 0, 0, 0.6); border: 2px solid var(--lcars-blue); border-radius: var(--radius-sm); max-height: 400px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse; color: var(--lcars-text);">
                                <thead style="background: rgba(153, 204, 255, 0.1); position: sticky; top: 0;">
                                    <tr>
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--lcars-teal); color: var(--lcars-gold); font-weight: 600;">Frequency</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--lcars-teal); color: var(--lcars-gold); font-weight: 600;">S-Meter</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--lcars-teal); color: var(--lcars-gold); font-weight: 600;">Mode</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--lcars-teal); color: var(--lcars-gold); font-weight: 600;">Status</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--lcars-teal); color: var(--lcars-gold); font-weight: 600;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="scanResultsTable">
                                    <tr>
                                        <td colspan="5" style="padding: 2rem; text-align: center; color: var(--lcars-peach); font-style: italic;">
                                            No scan results yet. Start a scan to see active frequencies.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="form-actions" style="margin-top: 1rem;">
                            <button class="btn" onclick="clearScanResults()" 
                                    title="Clear all scan results from the table">CLEAR RESULTS</button>
                            <button class="btn" onclick="exportScanResults()" 
                                    title="Export scan results to CSV file">EXPORT CSV</button>
                            <button class="btn primary" onclick="scanActiveOnly()" 
                                    title="Rescan only previously active frequencies">RESCAN ACTIVE</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SYSTEM Tab -->
            <div class="tab-content" id="system">
                <div class="lcars-panel full-width">
                    <div class="lcars-panel-header">
                        <div class="lcars-panel-indicator orange"></div>
                        <div class="lcars-panel-title">💾 Memory System</div>
                    </div>

                    <div class="main-grid">
                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator blue"></div>
                                <div class="lcars-panel-title">Memory Channels (1-99)</div>
                            </div>

                            <div class="memory-list" id="memoryList">
                                <!-- Memory channels will be populated here -->
                            </div>

                            <div class="placeholder-message">
                                Memory API coming soon
                            </div>
                        </div>

                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator green"></div>
                                <div class="lcars-panel-title">Memory Operations</div>
                            </div>

                            <div class="form-group">
                                <label>Channel Selection</label>
                                <div class="form-row">
                                    <input type="number" id="memoryChannel" placeholder="01" min="1" max="99" 
                                           title="Memory channel number (1-99)">
                                    <button class="btn primary" onclick="recallMemory()" 
                                            title="Load selected memory channel to VFO-A">RECALL</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <button class="btn success" onclick="storeMemory()" 
                                        title="Save current VFO-A frequency to selected memory slot">STORE TO MEMORY</button>
                            </div>

                            <div class="form-group">
                                <label>Memory Bank Operations</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <button class="btn btn-small" onclick="scanMemories()" 
                                            title="Scan all programmed memory channels">SCAN</button>
                                    <button class="btn btn-small danger" onclick="clearMemory()" 
                                            title="Clear selected memory channel">CLEAR</button>
                                </div>
                            </div>

                            <div class="status-grid">
                                <div class="status-item">
                                    <div class="status-label">Total Memories</div>
                                    <div class="status-value" id="totalMemories">99</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Programmed</div>
                                    <div class="status-value" id="programmedMemories">0</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Current</div>
                                    <div class="status-value" id="currentMemory">-</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Scan Mode</div>
                                    <div class="status-value" id="scanMode">OFF</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONFIG Tab -->
            <div class="tab-content" id="config">
                <div class="lcars-panel full-width">
                    <div class="lcars-panel-header">
                        <div class="lcars-panel-indicator purple"></div>
                        <div class="lcars-panel-title">⚙️ Configuration</div>
                    </div>

                    <div class="main-grid">
                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator orange"></div>
                                <div class="lcars-panel-title">Serial Port Settings</div>
                            </div>

                            <div class="form-group">
                                <label>Serial Port Path</label>
                                <input type="text" id="serialPort" value="/dev/ttyUSB0" 
                                       title="Serial port path for FT-991A CAT connection">
                            </div>

                            <div class="form-group">
                                <label>Baud Rate</label>
                                <select id="baudRate" title="CAT serial baud rate">
                                    <option value="4800">4800</option>
                                    <option value="9600" selected>9600</option>
                                    <option value="19200">19200</option>
                                    <option value="38400">38400</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 1rem;">
                                    <span>Auto-reconnect</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="autoReconnect" checked 
                                               title="Automatically reconnect if connection is lost">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </label>
                            </div>

                            <div class="form-actions">
                                <button class="btn primary" onclick="applyConfig()" 
                                        title="Apply configuration changes and reconnect">APPLY</button>
                                <button class="btn success" onclick="saveConfig()" 
                                        title="Save configuration to persist across restarts">SAVE</button>
                            </div>
                        </div>

                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator green"></div>
                                <div class="lcars-panel-title">Interface Settings</div>
                            </div>

                            <div class="form-group">
                                <label>Update Rate</label>
                                <select id="updateRate" title="How often to refresh radio status">
                                    <option value="100">100ms (Fast)</option>
                                    <option value="250" selected>250ms (Normal)</option>
                                    <option value="500">500ms (Slow)</option>
                                    <option value="1000">1000ms (Very Slow)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 1rem;">
                                    <span>Debug Mode</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="debugMode" 
                                               title="Enable debug logging for troubleshooting">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </label>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 1rem;">
                                    <span>Audio Notifications</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="audioNotifications" checked 
                                               title="Enable audio alerts for status changes">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </label>
                            </div>

                            <div class="status-grid">
                                <div class="status-item">
                                    <div class="status-label">Config Status</div>
                                    <div class="status-value active" id="configStatus">LOADED</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Last Saved</div>
                                    <div class="status-value" id="lastSaved">Never</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATUS Tab -->
            <div class="tab-content" id="status">
                <div class="lcars-panel full-width">
                    <div class="lcars-panel-header">
                        <div class="lcars-panel-indicator blue"></div>
                        <div class="lcars-panel-title">📊 Real-time Status Dashboard</div>
                    </div>

                    <div class="main-grid">
                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator green"></div>
                                <div class="lcars-panel-title">Station Information</div>
                            </div>

                            <div class="status-grid">
                                <div class="status-item">
                                    <div class="status-label">Callsign</div>
                                    <div class="status-value active" id="stationCallsign">KO4TUV</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Grid Square</div>
                                    <div class="status-value" id="gridSquare">EM84</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Power Class</div>
                                    <div class="status-value" id="powerClass">GENERAL</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">License</div>
                                    <div class="status-value active" id="licenseStatus">VALID</div>
                                </div>
                            </div>

                            <div class="diagnostic-item">
                                <h4>Radio Status</h4>
                                <div class="status-grid">
                                    <div class="status-item">
                                        <div class="status-label">VFO-A</div>
                                        <div class="status-value" id="statusVfoA">14.074.000</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">Mode</div>
                                        <div class="status-value" id="statusModeDisplay">DATA_USB</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">TX Power</div>
                                        <div class="status-value" id="statusTxPower">50W</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">S-Meter</div>
                                        <div class="status-value" id="statusSMeter">S0</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator purple"></div>
                                <div class="lcars-panel-title">Server Information</div>
                            </div>

                            <div class="status-grid">
                                <div class="status-item">
                                    <div class="status-label">Hostname</div>
                                    <div class="status-value" id="serverHostname">loading...</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Uptime</div>
                                    <div class="status-value" id="serverUptime">loading...</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">IP Address</div>
                                    <div class="status-value" id="serverIP">192.168.10.179</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Port</div>
                                    <div class="status-value" id="serverPort">8000</div>
                                </div>
                            </div>

                            <div class="diagnostic-item">
                                <h4>Connection Status</h4>
                                <div class="status-grid">
                                    <div class="status-item">
                                        <div class="status-label">WebSocket</div>
                                        <div class="status-value" id="wsStatus">CONNECTING</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">Connected Clients</div>
                                        <div class="status-value" id="connectedClients">1</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">Last Update</div>
                                        <div class="status-value" id="lastUpdate">Never</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">Data Rate</div>
                                        <div class="status-value" id="dataRate">0 B/s</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lcars-panel">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator orange"></div>
                            <div class="lcars-panel-title">Live System Metrics</div>
                        </div>

                        <div class="main-grid">
                            <div class="status-grid">
                                <div class="status-item">
                                    <div class="status-label">CPU Usage</div>
                                    <div class="status-value" id="cpuUsage">0%</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Memory</div>
                                    <div class="status-value" id="memoryUsage">0%</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Temperature</div>
                                    <div class="status-value" id="cpuTemp">0°C</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Load Avg</div>
                                    <div class="status-value" id="loadAvg">0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DIAGNOSTICS Tab -->
            <div class="tab-content" id="diag">
                <div class="lcars-panel full-width">
                    <div class="lcars-panel-header">
                        <div class="lcars-panel-indicator red"></div>
                        <div class="lcars-panel-title">🔍 System Diagnostics</div>
                    </div>

                    <div class="main-grid">
                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator orange"></div>
                                <div class="lcars-panel-title">Connection Diagnostics</div>
                            </div>

                            <div class="status-grid">
                                <div class="status-item">
                                    <div class="status-label">Serial Port</div>
                                    <div class="status-value" id="diagSerialStatus">UNKNOWN</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">CAT Commands</div>
                                    <div class="status-value" id="diagCatCommands">0</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">WebSocket</div>
                                    <div class="status-value" id="diagWsStatus">DISCONNECTED</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Uptime</div>
                                    <div class="status-value" id="diagUptime">00:00:00</div>
                                </div>
                            </div>

                            <div class="diagnostic-item">
                                <h4>Last CAT Commands</h4>
                                <div style="font-family: monospace; font-size: 0.85rem; color: var(--lcars-text);">
                                    <div>TX: <span id="lastTxCommand">None</span></div>
                                    <div>RX: <span id="lastRxCommand">None</span></div>
                                    <div>Time: <span id="lastCommandTime">Never</span></div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button class="btn primary" onclick="runDiagnostics()" 
                                        title="Run comprehensive system diagnostics">RUN TESTS</button>
                                <button class="btn" onclick="reconnectRadio()" 
                                        title="Attempt to reconnect to FT-991A transceiver">RECONNECT</button>
                            </div>
                        </div>

                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <div class="lcars-panel-indicator red"></div>
                                <div class="lcars-panel-title">Error Log</div>
                            </div>

                            <div class="error-log" id="errorLog">
                                <div class="error-entry">
                                    <div class="error-timestamp">[System Ready]</div>
                                    No errors logged
                                </div>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-small" onclick="clearErrorLog()" 
                                        title="Clear all error log entries">CLEAR LOG</button>
                                <button class="btn btn-small" onclick="exportErrorLog()" 
                                        title="Export error log for debugging">EXPORT</button>
                            </div>
                        </div>
                    </div>

                    <div class="lcars-panel">
                        <div class="lcars-panel-header">
                            <div class="lcars-panel-indicator purple"></div>
                            <div class="lcars-panel-title">Performance Metrics</div>
                        </div>

                        <div class="status-grid">
                            <div class="status-item">
                                <div class="status-label">Response Time</div>
                                <div class="status-value" id="responseTime">0ms</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Success Rate</div>
                                <div class="status-value" id="successRate">100%</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Commands/Min</div>
                                <div class="status-value" id="commandRate">0</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Buffer Usage</div>
                                <div class="status-value" id="bufferUsage">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ── Global State ────────────────────────────────────────
        let ws = null;
        let audioWs = null;
        let radioStatus = {};
        let txLockout = false;
        let knobInteraction = false;
        let currentTuningStep = 1000; // Default 1 kHz
        let audioPlaying = false;
        let audioMuted = false;
        let currentVolume = 50;

        // ── Audio Waterfall State ──────────────────────────────
        let waterfallCanvas = null;
        let waterfallCtx = null;
        let audioContext = null;
        let audioGainNode = null;
        let audioListening = false;
        let audioScriptProcessor = null;
        let analyserNode = null;
        let waterfallRunning = false;
        let waterfallData = [];
        let waterfallConfig = {
            fftSize: 1024,
            zoomLevel: 1,
            scrollSpeed: 5,
            colorPalette: 'radio',
            canvasHeight: 400
        };
        let audioLevel = 0;
        let frequencyData = null;

        // ── SDR Waterfall State ─────────────────────────────────
        let sdrWs = null;
        let sdrCanvas = null;
        let sdrCtx = null;
        let sdrRunning = false;
        let sdrWaterfallData = [];
        let sdrConfig = {
            bandwidth: 2000000,  // 2 MHz default
            fftSize: 1024,
            scrollSpeed: 10,
            colorPalette: 'radio',
            canvasHeight: 400,
            centerFreq: 14250000  // Default center frequency
        };
        let sdrSignalLevel = -100;  // dB

        // ── Tab Management ──────────────────────────────────────
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav items (both sidebar and mobile)
            document.querySelectorAll('.lcars-nav-item, .mobile-nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            
            // Add active class to corresponding nav items (both sidebar and mobile)
            document.querySelectorAll(`[data-tab="${tabId}"]`).forEach(nav => {
                nav.classList.add('active');
            });
            
            // Update status displays for certain tabs
            if (tabId === 'status') {
                updateStatusTab();
            } else if (tabId === 'system') {
                loadMemoryChannels();
            } else if (tabId === 'memory') {
                updateVfoForMemory();
            } else if (tabId === 'diag') {
                updateDiagnosticsTab();
            } else if (tabId === 'sdr') {
                initSDRWaterfall();
                updateSDRBandwidthDisplay();
                updateSDRFFTDisplay();
            }
        }

        // ── WebSocket Connection ────────────────────────────────
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                // Attempt reconnection after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
                logError('WebSocket connection error: ' + error.message);
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'status':
                    updateRadioStatus(data.data);
                    break;
                case 'connection':
                    updateConnectionStatus(data.status === 'connected');
                    break;
                case 'error':
                    logError(data.message);
                    break;
                case 'scan_progress':
                case 'scan_complete':
                case 'scan_error':
                    handleScanMessage(data);
                    break;
                default:
                    console.log('Unknown message type:', data.type);
            }
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'CONNECTED';
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'DISCONNECTED';
            }

            // Update status displays
            updateStatusDisplays(connected);
        }

        // ── Radio Status Updates ────────────────────────────────
        function updateRadioStatus(status) {
            radioStatus = status;
            
            // Update frequency displays with full precision
            document.getElementById('frequencyA').textContent = formatFrequencyPrecise(status.frequency_a);
            document.getElementById('frequencyB').textContent = formatFrequencyPrecise(status.frequency_b);
            
            // Update mode
            document.getElementById('currentMode').textContent = status.mode;
            if (document.getElementById('statusMode')) {
                document.getElementById('statusMode').textContent = status.mode;
            }
            
            // Update SDR displays
            if (document.getElementById('sdrFreqDisplay')) {
                document.getElementById('sdrFreqDisplay').textContent = formatFrequencyPrecise(status.frequency_a);
            }
            if (document.getElementById('sdrModeBadge')) {
                document.getElementById('sdrModeBadge').textContent = status.mode;
            }
            
            // Update TX status
            const txStatus = document.getElementById('txStatus');
            const pttButton = document.getElementById('pttButton');
            if (status.tx_active) {
                txStatus.textContent = 'TX';
                txStatus.className = 'status-value danger';
                pttButton.classList.add('active');
            } else {
                txStatus.textContent = 'RX';
                txStatus.className = 'status-value';
                pttButton.classList.remove('active');
            }
            
            // Update squelch
            const squelch = document.getElementById('squelchStatus');
            squelch.textContent = status.squelch_open ? 'OPEN' : 'CLOSED';
            squelch.className = status.squelch_open ? 'status-value active' : 'status-value';
            
            // Update S-meter
            updateSMeter(status.s_meter);
            
            // Update power
            document.getElementById('powerOut').textContent = `${status.power_output}W`;
            
            // Update SWR
            document.getElementById('swrValue').textContent = formatSWR(status.swr);
            
            // Update lockout status
            txLockout = status.tx_lockout;
            updateLockoutDisplay();
            
            // Update status tab displays
            updateStatusTabData(status);
            
            // Update memory tab VFO display
            updateVfoForMemory();
            
            // Update last update time
            updateLastUpdateTime();
        }

        function formatFrequency(hz) {
            const mhz = hz / 1000000;
            return mhz.toFixed(6);
        }

        function formatFrequencyPrecise(hz) {
            const mhz = hz / 1000000;
            // Format as xx.xxx.xxx to show full Hz precision
            const parts = mhz.toFixed(6).split('.');
            if (parts[1]) {
                return `${parts[0]}.${parts[1].substring(0,3)}.${parts[1].substring(3)}`;
            }
            return mhz.toFixed(6);
        }

        function formatSWR(rawSwr) {
            // Convert raw SWR meter reading to ratio
            // This is an approximation - actual formula may vary
            const swr = 1 + (rawSwr / 255) * 4; // Scale to 1:1 - 5:1 range
            return `${swr.toFixed(1)}:1`;
        }

        function updateSMeter(level) {
            const percentage = (level / 255) * 100;
            document.getElementById('sMeterBar').style.width = `${percentage}%`;
            
            // Convert to S-units (approximate)
            let sValue;
            if (level < 42) sValue = 0;
            else if (level < 84) sValue = Math.floor((level - 42) / 6) + 1;
            else sValue = 9 + Math.floor((level - 84) / 17);
            
            if (sValue <= 9) {
                document.getElementById('sMeterValue').textContent = `S${sValue}`;
            } else {
                document.getElementById('sMeterValue').textContent = `S9+${(sValue - 9) * 10}`;
            }
        }

        // ── Fine Tuning Controls ────────────────────────────────
        function setTuningStep(stepHz) {
            currentTuningStep = stepHz;
            
            // Update active step button
            document.querySelectorAll('.step-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-step="${stepHz}"]`).classList.add('active');
            
            // Update step display
            updateStepDisplay();
        }

        function updateStepDisplay() {
            const display = document.getElementById('stepDisplay');
            let stepText;
            
            if (currentTuningStep >= 1000000) {
                stepText = `${currentTuningStep / 1000000} MHz`;
            } else if (currentTuningStep >= 1000) {
                stepText = `${currentTuningStep / 1000} kHz`;
            } else {
                stepText = `${currentTuningStep} Hz`;
            }
            
            display.textContent = `Step: ${stepText}`;
        }

        function nudgeFrequency(direction) {
            if (!radioStatus.frequency_a) {
                console.log('No frequency data available');
                return;
            }
            
            const currentFreq = radioStatus.frequency_a;
            let newFreq;
            
            if (direction === 'up') {
                newFreq = currentFreq + currentTuningStep;
            } else {
                newFreq = currentFreq - currentTuningStep;
            }
            
            // Bounds checking
            newFreq = Math.max(30000, Math.min(470000000, newFreq));
            
            console.log(`Nudging frequency ${direction}: ${currentFreq} → ${newFreq} (step: ${currentTuningStep})`);
            
            apiCall('/frequency/a', 'POST', { frequency: newFreq });
        }

        // ── API Calls ───────────────────────────────────────────
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`/api${endpoint}`, options);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`API call failed: ${endpoint}`, error);
                logError(`API call failed: ${endpoint} - ${error.message}`);
                throw error;
            }
        }

        // ── Frequency Control ───────────────────────────────────
        function setDirectFrequency() {
            const freq = parseInt(document.getElementById('directFreq').value);
            if (isNaN(freq) || freq < 30000 || freq > 470000000) {
                alert('Invalid frequency. Enter frequency in Hz (30 kHz - 470 MHz)');
                return;
            }
            
            apiCall('/frequency/a', 'POST', { frequency: freq });
        }

        function setFT8Frequency(freq) {
            apiCall('/frequency/a', 'POST', { frequency: freq })
                .then(() => apiCall('/mode', 'POST', { mode: 'DATA_USB' }));
        }

        // ── VFO Operations ──────────────────────────────────────
        async function startAutoTune() {
            const btns = document.querySelectorAll('#autoTuneBtn, #autoTuneBtnVfo');
            btns.forEach(b => { b.textContent = '⚡ TUNING...'; b.style.background = 'var(--lcars-red)'; b.style.color = '#fff'; b.disabled = true; });
            try {
                const resp = await apiCall('/tuner/start', 'POST');
                // FT-991A ATU typically takes 3-8 seconds; no status query available
                setTimeout(() => {
                    btns.forEach(b => { b.textContent = '⚡ AUTO TUNE'; b.style.background = 'var(--lcars-gold)'; b.style.color = '#000'; b.disabled = false; });
                }, 8000);
            } catch(e) {
                console.error('Auto-tune error:', e);
                btns.forEach(b => { b.textContent = '⚡ AUTO TUNE'; b.style.background = 'var(--lcars-gold)'; b.style.color = '#000'; b.disabled = false; });
            }
        }

        function swapVfo() {
            apiCall('/vfo/swap', 'POST');
        }

        function copyAtoB() {
            apiCall('/vfo/a-to-b', 'POST');
        }

        // ── Mode Control ────────────────────────────────────────
        function setMode(mode) {
            apiCall('/mode', 'POST', { mode: mode });
        }

        // ── Band Control ────────────────────────────────────────
        function setBand(band) {
            apiCall('/band', 'POST', { band: band });
        }

        // ── Power Control ───────────────────────────────────────
        function updatePower(watts) {
            document.getElementById('powerValue').textContent = `${watts}W`;
        }

        function setPowerPreset(watts) {
            document.getElementById('powerSlider').value = watts;
            updatePower(watts);
            apiCall('/power', 'POST', { power: watts });
        }

        // ── PTT Control ─────────────────────────────────────────
        function pttPress() {
            if (txLockout) {
                alert('TX Lockout is enabled. Disable lockout to transmit.');
                return;
            }
            
            apiCall('/ptt', 'POST', { enable: true });
        }

        function pttRelease() {
            apiCall('/ptt', 'POST', { enable: false });
        }

        // ── TX Lockout ──────────────────────────────────────────
        function toggleLockout() {
            apiCall('/lockout', 'POST').then(response => {
                txLockout = response.lockout;
                updateLockoutDisplay();
            });
        }

        function updateLockoutDisplay() {
            const button = document.getElementById('lockoutButton');
            const status = document.getElementById('lockoutStatus');
            
            if (txLockout) {
                button.classList.add('active');
                button.textContent = '🔒 LOCKED';
                status.textContent = 'ON';
                status.className = 'status-value danger';
            } else {
                button.classList.remove('active');
                button.textContent = '🔓 UNLOCKED';
                status.textContent = 'OFF';
                status.className = 'status-value';
            }
        }

        // ── Audio Functions ─────────────────────────────────────
        function toggleAudioStream() {
            const button = document.getElementById('audioPlayButton');
            
            if (audioPlaying) {
                // Stop audio
                audioPlaying = false;
                button.textContent = '▶ START AUDIO';
                button.classList.remove('danger');
                button.classList.add('success');
                logError('Audio stream stopped (placeholder - ffmpeg integration needed)');
            } else {
                // Start audio
                audioPlaying = true;
                button.textContent = '⏹ STOP AUDIO';
                button.classList.remove('success');
                button.classList.add('danger');
                logError('Audio stream started (placeholder - ffmpeg integration needed)');
            }
        }

        function updateVolume(value) {
            currentVolume = value;
            document.getElementById('volumeValue').textContent = `${value}%`;
            
            if (audioMuted) {
                document.getElementById('volumeValue').style.textDecoration = 'line-through';
            } else {
                document.getElementById('volumeValue').style.textDecoration = 'none';
            }
        }

        function toggleMute() {
            const button = document.getElementById('muteButton');
            const volumeDisplay = document.getElementById('volumeValue');
            
            audioMuted = !audioMuted;
            
            if (audioMuted) {
                button.textContent = '🔇 UNMUTE';
                button.classList.add('danger');
                volumeDisplay.style.textDecoration = 'line-through';
            } else {
                button.textContent = '🔊 MUTE';
                button.classList.remove('danger');
                volumeDisplay.style.textDecoration = 'none';
            }
        }

        // ── Memory Functions ────────────────────────────────────
        function loadMemoryChannels() {
            const memoryList = document.getElementById('memoryList');
            memoryList.innerHTML = '';
            
            // Generate placeholder memory channels
            for (let i = 1; i <= 99; i++) {
                const memoryItem = document.createElement('div');
                memoryItem.className = 'memory-item';
                
                // Placeholder data (would come from API)
                const freq = i <= 20 ? `${(14.000 + i * 0.025).toFixed(3)}` : '';
                const mode = i <= 20 ? (i % 3 === 0 ? 'CW' : i % 2 === 0 ? 'USB' : 'DATA_USB') : '';
                
                memoryItem.innerHTML = `
                    <div class="memory-channel">${i.toString().padStart(2, '0')}</div>
                    <div class="memory-frequency">${freq ? freq + ' MHz' : '---'}</div>
                    <div class="memory-mode">${mode || '---'}</div>
                    <div class="memory-name">${freq ? `MEM${i}` : 'Empty'}</div>
                    <div class="memory-actions">
                        <button class="btn btn-small" onclick="recallMemoryChannel(${i})" 
                                title="Load this memory channel to VFO-A" ${!freq ? 'disabled' : ''}>RECALL</button>
                        <button class="btn btn-small primary" onclick="storeToMemoryChannel(${i})" 
                                title="Save current VFO-A frequency to this memory slot">STORE</button>
                    </div>
                `;
                
                memoryList.appendChild(memoryItem);
            }
        }

        function recallMemory() {
            const channel = document.getElementById('memoryChannel').value;
            if (!channel || channel < 1 || channel > 99) {
                alert('Please enter a valid memory channel (1-99)');
                return;
            }
            
            // Placeholder - would call API
            console.log('Memory API coming soon - would recall channel', channel);
            logError(`Memory recall channel ${channel} - API endpoint needed`);
        }

        function storeMemory() {
            const channel = document.getElementById('memoryChannel').value;
            if (!channel || channel < 1 || channel > 99) {
                alert('Please enter a valid memory channel (1-99)');
                return;
            }
            
            // Placeholder - would call API
            console.log('Memory API coming soon - would store to channel', channel);
            logError(`Memory store to channel ${channel} - API endpoint needed`);
        }

        function recallMemoryChannel(channel) {
            console.log('Memory API coming soon - would recall channel', channel);
            logError(`Memory recall channel ${channel} - API endpoint needed`);
        }

        function storeToMemoryChannel(channel) {
            console.log('Memory API coming soon - would store to channel', channel);
            logError(`Memory store to channel ${channel} - API endpoint needed`);
        }

        function scanMemories() {
            console.log('Memory scan API coming soon');
            logError('Memory scan feature - API endpoint needed');
        }

        function clearMemory() {
            const channel = document.getElementById('memoryChannel').value;
            if (!channel || channel < 1 || channel > 99) {
                alert('Please enter a valid memory channel (1-99)');
                return;
            }
            
            if (confirm(`Clear memory channel ${channel}?`)) {
                console.log('Memory API coming soon - would clear channel', channel);
                logError(`Memory clear channel ${channel} - API endpoint needed`);
            }
        }

        // ── Configuration Functions ─────────────────────────────
        function applyConfig() {
            const config = {
                serialPort: document.getElementById('serialPort').value,
                baudRate: document.getElementById('baudRate').value,
                autoReconnect: document.getElementById('autoReconnect').checked,
                updateRate: document.getElementById('updateRate').value,
                debugMode: document.getElementById('debugMode').checked,
                audioNotifications: document.getElementById('audioNotifications').checked
            };
            
            console.log('Applying configuration:', config);
            
            // Placeholder - would POST to /api/config
            logError('Configuration applied - server restart may be required');
            
            // Update status
            document.getElementById('configStatus').textContent = 'APPLIED';
            document.getElementById('configStatus').className = 'status-value active';
        }

        function saveConfig() {
            console.log('Saving configuration');
            logError('Configuration saved to persistent storage');
            
            // Update status
            document.getElementById('lastSaved').textContent = new Date().toLocaleTimeString();
        }

        // ── Status Tab Functions ────────────────────────────────
        function updateStatusTab() {
            // Update server info
            fetch('/api/status').then(response => response.json()).then(data => {
                if (data.server) {
                    document.getElementById('serverHostname').textContent = data.server.hostname || 'Unknown';
                    document.getElementById('serverUptime').textContent = formatUptime(data.server.uptime) || '00:00:00';
                }
            }).catch(() => {
                document.getElementById('serverHostname').textContent = 'Error';
                document.getElementById('serverUptime').textContent = 'Error';
            });
        }

        function updateStatusTabData(status) {
            // Update status tab with radio data
            const elements = {
                'statusVfoA': formatFrequencyPrecise(status.frequency_a),
                'statusModeDisplay': status.mode,
                'statusTxPower': `${status.power_output}W`,
                'statusSMeter': document.getElementById('sMeterValue')?.textContent || 'S0'
            };
            
            for (const [id, value] of Object.entries(elements)) {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            }
        }

        function updateStatusDisplays(connected) {
            // Update WebSocket status
            const wsStatus = document.getElementById('wsStatus');
            if (wsStatus) {
                wsStatus.textContent = connected ? 'CONNECTED' : 'DISCONNECTED';
                wsStatus.className = connected ? 'status-value active' : 'status-value danger';
            }
            
            // Update diagnostics
            const diagWsStatus = document.getElementById('diagWsStatus');
            if (diagWsStatus) {
                diagWsStatus.textContent = connected ? 'CONNECTED' : 'DISCONNECTED';
                diagWsStatus.className = connected ? 'status-value active' : 'status-value danger';
            }
        }

        function updateLastUpdateTime() {
            const now = new Date().toLocaleTimeString();
            const lastUpdate = document.getElementById('lastUpdate');
            if (lastUpdate) {
                lastUpdate.textContent = now;
            }
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ── Diagnostics Functions ───────────────────────────────
        function updateDiagnosticsTab() {
            // Update diagnostics displays
            const diagUptime = document.getElementById('diagUptime');
            if (diagUptime) {
                const startTime = Date.now() - (performance.now() || 0);
                const uptimeSeconds = Math.floor((Date.now() - startTime) / 1000);
                diagUptime.textContent = formatUptime(uptimeSeconds);
            }
        }

        function runDiagnostics() {
            logError('Running system diagnostics...');
            
            // Simulate diagnostics
            setTimeout(() => {
                logError('Serial port test: PASSED');
                logError('WebSocket test: PASSED');
                logError('CAT command test: PASSED');
                logError('All diagnostics completed successfully');
            }, 1000);
        }

        function clearErrorLog() {
            const errorLog = document.getElementById('errorLog');
            errorLog.innerHTML = '<div class="error-entry"><div class="error-timestamp">[Log Cleared]</div>No errors logged</div>';
        }

        function exportErrorLog() {
            const errorLog = document.getElementById('errorLog');
            const logText = errorLog.textContent;
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ft991a-error-log-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function logError(message) {
            const errorLog = document.getElementById('errorLog');
            if (!errorLog) return;
            
            const entry = document.createElement('div');
            entry.className = 'error-entry';
            entry.innerHTML = `
                <div class="error-timestamp">[${new Date().toLocaleTimeString()}]</div>
                ${message}
            `;
            
            // Remove "No errors logged" message if present
            if (errorLog.textContent.includes('No errors logged')) {
                errorLog.innerHTML = '';
            }
            
            errorLog.insertBefore(entry, errorLog.firstChild);
            
            // Keep only last 10 entries
            while (errorLog.children.length > 10) {
                errorLog.removeChild(errorLog.lastChild);
            }
        }

        // ── Reconnect Function ──────────────────────────────────
        function reconnectRadio() {
            console.log('Manual reconnect requested');
            logError('Manual reconnection initiated');
            
            if (ws) {
                ws.close();
            }
            setTimeout(connectWebSocket, 1000);
            
            // Also try to refresh radio status
            apiCall('/status').then(data => {
                if (data.connected) {
                    updateRadioStatus(data.status);
                }
            }).catch(error => {
                console.log('Reconnect status check failed:', error);
                logError('Reconnect status check failed: ' + error.message);
            });
        }

        // ── VFO Knob Simulation ─────────────────────────────────
        function initKnobControls() {
            const knobs = document.querySelectorAll('.knob');
            
            knobs.forEach(knob => {
                let isDragging = false;
                let startAngle = 0;
                let currentRotation = 0;
                let lastFreq = 0;
                
                function getAngle(event) {
                    const rect = knob.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    const clientX = event.clientX || (event.touches && event.touches[0].clientX);
                    const clientY = event.clientY || (event.touches && event.touches[0].clientY);
                    
                    return Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
                }
                
                function startDrag(event) {
                    isDragging = true;
                    knobInteraction = true;
                    startAngle = getAngle(event);
                    
                    const vfo = knob.dataset.vfo;
                    lastFreq = vfo === 'a' ? radioStatus.frequency_a : radioStatus.frequency_b;
                    
                    event.preventDefault();
                }
                
                function drag(event) {
                    if (!isDragging) return;
                    
                    const currentAngle = getAngle(event);
                    let deltaAngle = currentAngle - startAngle;
                    
                    // Handle angle wrap-around
                    if (deltaAngle > 180) deltaAngle -= 360;
                    if (deltaAngle < -180) deltaAngle += 360;
                    
                    currentRotation += deltaAngle;
                    startAngle = currentAngle;
                    
                    // Update knob visual rotation
                    knob.style.transform = `rotate(${currentRotation}deg)`;
                    
                    // Calculate frequency change (1° = 1kHz for fine tuning)
                    const freqChange = Math.round(deltaAngle * 1000);
                    const newFreq = Math.max(30000, Math.min(470000000, lastFreq + freqChange));
                    
                    if (Math.abs(newFreq - lastFreq) >= 1000) { // Minimum 1kHz change
                        const vfo = knob.dataset.vfo;
                        const endpoint = vfo === 'a' ? '/frequency/a' : '/frequency/b';
                        
                        apiCall(endpoint, 'POST', { frequency: newFreq });
                        lastFreq = newFreq;
                    }
                    
                    event.preventDefault();
                }
                
                function endDrag() {
                    isDragging = false;
                    knobInteraction = false;
                }
                
                // Mouse events
                knob.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', endDrag);
                
                // Touch events
                knob.addEventListener('touchstart', startDrag);
                document.addEventListener('touchmove', drag);
                document.addEventListener('touchend', endDrag);
            });
        }

        // ── Inline Tuner (Audio Tab) ──────────────────────────
        let tunerStep = 100; // Hz

        function setTunerStep(hz, el) {
            tunerStep = hz;
            document.querySelectorAll('#waterfallTuner .selector-btn').forEach(b => b.classList.remove('active'));
            if (el) el.classList.add('active');
        }

        function tuneUp() {
            if (!radioStatus || !radioStatus.frequency_a) { console.warn('tuneUp: no radioStatus'); return; }
            const newFreq = radioStatus.frequency_a + tunerStep;
            console.log(`tuneUp: ${radioStatus.frequency_a} + ${tunerStep} = ${newFreq}`);
            fetch('/api/frequency/a', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({frequency: newFreq}) })
                .then(r => r.json()).then(d => console.log('tuneUp result:', d)).catch(e => console.error('tuneUp error:', e));
        }

        function tuneDown() {
            if (!radioStatus || !radioStatus.frequency_a) { console.warn('tuneDown: no radioStatus'); return; }
            const newFreq = radioStatus.frequency_a - tunerStep;
            if (newFreq > 0) {
                console.log(`tuneDown: ${radioStatus.frequency_a} - ${tunerStep} = ${newFreq}`);
                fetch('/api/frequency/a', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({frequency: newFreq}) })
                    .then(r => r.json()).then(d => console.log('tuneDown result:', d)).catch(e => console.error('tuneDown error:', e));
            }
        }

        function showFreqInput() {
            const display = document.getElementById('tunerFreqDisplay');
            const input = document.getElementById('tunerFreqInput');
            // Pre-fill with clean MHz decimal (e.g. "14.250000") for easy editing
            if (radioStatus && radioStatus.frequency_a) {
                input.value = (radioStatus.frequency_a / 1000000).toFixed(6);
            } else {
                input.value = display.textContent.trim();
            }
            display.style.display = 'none';
            input.style.display = 'block';
            input.focus();
            input.select();
        }

        function hideTunerFreqInput() {
            document.getElementById('tunerFreqDisplay').style.display = '';
            document.getElementById('tunerFreqInput').style.display = 'none';
        }

        function submitTunerFreq() {
            const input = document.getElementById('tunerFreqInput');
            let raw = input.value.trim();
            // Handle dotted format like "14.250.000" → "14250000" Hz
            // or plain MHz like "14.25" → 14250000 Hz
            // or plain kHz like "14250" → 14250000 Hz
            const dots = (raw.match(/\./g) || []).length;
            let hz;
            if (dots >= 2) {
                // Dotted display format: "14.250.000" → remove all dots → Hz
                hz = parseInt(raw.replace(/\./g, ''), 10);
            } else if (dots === 1) {
                // Standard decimal MHz: "14.25" → Hz
                hz = Math.round(parseFloat(raw) * 1000000);
            } else {
                // No dots — if > 30000 assume Hz, else assume kHz
                const num = parseInt(raw, 10);
                hz = num > 30000 ? num : num * 1000;
            }
            if (hz && hz > 100000 && hz < 500000000) {
                fetch('/api/frequency/a', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({frequency: hz}) });
            }
            hideTunerFreqInput();
        }

        function updateTunerStrip(status) {
            if (!status || !status.frequency_a) return;
            // Frequency
            const mhz = status.frequency_a / 1000000;
            const formatted = mhz.toFixed(6).replace(/(\d)(?=(\d{3})+\.)/g, '$1.');
            const el = document.getElementById('tunerFreqDisplay');
            if (el) el.textContent = formatted;
            // Also update waterfall center frequency display
            const cfd = document.getElementById('currentFreqDisplay');
            if (cfd) cfd.textContent = formatted + ' MHz';
            // Mode
            const mode = document.getElementById('tunerModeBadge');
            if (mode) mode.textContent = status.mode || 'N/A';
            // S-meter (0-255 range → percentage + S-unit)
            const sm = status.s_meter || 0;
            const pct = Math.min(100, (sm / 255) * 100);
            const bar = document.getElementById('tunerSmeterBar');
            if (bar) bar.style.width = pct + '%';
            const sUnit = sm < 20 ? 'S0' : sm < 40 ? 'S1' : sm < 60 ? 'S2' : sm < 80 ? 'S3' : sm < 100 ? 'S4' : sm < 120 ? 'S5' : sm < 140 ? 'S6' : sm < 160 ? 'S7' : sm < 180 ? 'S8' : sm < 200 ? 'S9' : 'S9+' + Math.round((sm-200)/5);
            const sVal = document.getElementById('tunerSmeterVal');
            if (sVal) sVal.textContent = sUnit;
        }

        // Hook into existing WebSocket status updates
        const _origHandleStatus = window._origHandleStatus || null;
        (function() {
            const origWsOnMessage = null; // will patch in initWaterfall
            // Patch: call updateTunerStrip whenever status updates
            const _patchInterval = setInterval(() => {
                if (typeof radioStatus !== 'undefined' && radioStatus) {
                    updateTunerStrip(radioStatus);
                }
            }, 600);
        })();

        // Keyboard tuning: arrow keys when on audio tab
        document.addEventListener('keydown', function(e) {
            const audioTab = document.getElementById('audio');
            if (!audioTab || audioTab.style.display === 'none') return;
            if (document.activeElement.tagName === 'INPUT') return;
            if (e.key === 'ArrowUp' || e.key === 'ArrowRight') { e.preventDefault(); tuneUp(); }
            if (e.key === 'ArrowDown' || e.key === 'ArrowLeft') { e.preventDefault(); tuneDown(); }
        });

        // ── Audio Listen Controls ──────────────────────────
        function toggleListen() {
            audioListening = !audioListening;
            const btn = document.getElementById('listenButton');
            if (audioListening) {
                btn.innerHTML = '🔊 LISTENING';
                btn.style.background = 'var(--lcars-green)';
                if (audioGainNode) audioGainNode.gain.value = (document.getElementById('audioVolumeSlider').value / 100);
            } else {
                btn.innerHTML = '🔇 LISTEN OFF';
                btn.style.background = 'var(--lcars-blue)';
                if (audioGainNode) audioGainNode.gain.value = 0;
            }
            // Auto-start waterfall if not running
            if (audioListening && !waterfallRunning) {
                toggleWaterfall();
            }
        }

        function setAudioVolume(val) {
            document.getElementById('volumeValue').textContent = val + '%';
            if (audioGainNode && audioListening) {
                audioGainNode.gain.value = val / 100;
            }
        }

        // ── S-Meter History Chart ──────────────────────────
        const smeterHistory = [];
        const SMETER_MAX_POINTS = 120;
        let smeterPeakVal = 0;
        let smeterAnimFrame = null;

        function updateSmeterHistory(sVal) {
            smeterHistory.push(sVal);
            if (smeterHistory.length > SMETER_MAX_POINTS) smeterHistory.shift();
            if (sVal > smeterPeakVal) smeterPeakVal = sVal;
        }

        function drawSmeterChart() {
            const canvas = document.getElementById('smeterCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            if (smeterHistory.length < 2) return;

            // Grid lines at S-units
            ctx.strokeStyle = 'rgba(255,168,0,0.15)';
            ctx.lineWidth = 1;
            for (let s = 0; s <= 9; s++) {
                const y = h - (s / 9) * h * 0.8 - h * 0.1;
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
                ctx.fillStyle = 'rgba(255,168,0,0.3)';
                ctx.font = '10px Antonio';
                ctx.fillText('S' + s, 4, y - 2);
            }

            // Signal line
            const grad = ctx.createLinearGradient(0, h, 0, 0);
            grad.addColorStop(0, 'rgba(0,200,100,0.8)');
            grad.addColorStop(0.5, 'rgba(255,168,0,0.9)');
            grad.addColorStop(1, 'rgba(255,60,60,1)');
            ctx.strokeStyle = grad;
            ctx.lineWidth = 2;
            ctx.beginPath();
            const maxS = 255;
            for (let i = 0; i < smeterHistory.length; i++) {
                const x = (i / (SMETER_MAX_POINTS - 1)) * w;
                const y = h - (smeterHistory[i] / maxS) * h * 0.9 - h * 0.05;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Fill under curve
            ctx.lineTo((smeterHistory.length - 1) / (SMETER_MAX_POINTS - 1) * w, h);
            ctx.lineTo(0, h);
            ctx.closePath();
            const fillGrad = ctx.createLinearGradient(0, h, 0, 0);
            fillGrad.addColorStop(0, 'rgba(0,200,100,0.05)');
            fillGrad.addColorStop(1, 'rgba(255,168,0,0.2)');
            ctx.fillStyle = fillGrad;
            ctx.fill();

            // Update peak/avg labels
            const avg = smeterHistory.reduce((a, b) => a + b, 0) / smeterHistory.length;
            const peakEl = document.getElementById('smeterPeak');
            const avgEl = document.getElementById('smeterAvg');
            if (peakEl) peakEl.textContent = 'PEAK: ' + sUnitFromRaw(smeterPeakVal);
            if (avgEl) avgEl.textContent = 'AVG: ' + sUnitFromRaw(Math.round(avg));
        }

        function sUnitFromRaw(sm) {
            if (sm < 20) return 'S0';
            if (sm < 40) return 'S1';
            if (sm < 60) return 'S2';
            if (sm < 80) return 'S3';
            if (sm < 100) return 'S4';
            if (sm < 120) return 'S5';
            if (sm < 140) return 'S6';
            if (sm < 160) return 'S7';
            if (sm < 180) return 'S8';
            if (sm < 200) return 'S9';
            return 'S9+' + Math.round((sm - 200) / 5);
        }

        // Hook smeter into the status update cycle
        setInterval(() => {
            if (radioStatus && typeof radioStatus.s_meter !== 'undefined') {
                updateSmeterHistory(radioStatus.s_meter);
                drawSmeterChart();
            }
        }, 500);

        // ── Audio Waterfall Functions ──────────────────────────
        function initWaterfall() {
            waterfallCanvas = document.getElementById('waterfallCanvas');
            waterfallCtx = waterfallCanvas.getContext('2d');
            
            // Initialize waterfall data array
            waterfallData = [];
            
            // Set up canvas click handler for frequency selection
            waterfallCanvas.addEventListener('click', handleWaterfallClick);
            
            console.log('Waterfall display initialized');
        }
        
        function toggleWaterfall() {
            if (waterfallRunning) {
                stopWaterfall();
            } else {
                startWaterfall();
            }
        }
        
        async function startWaterfall() {
            if (waterfallRunning) return;
            
            try {
                // Initialize Web Audio API
                audioContext = new (window.AudioContext || window.webkitAudioContext)({sampleRate: 48000});
                analyserNode = audioContext.createAnalyser();
                analyserNode.fftSize = waterfallConfig.fftSize;
                analyserNode.smoothingTimeConstant = 0.8;
                
                // Audio playback chain: scriptProcessor → gainNode → destination
                audioGainNode = audioContext.createGain();
                audioGainNode.gain.value = audioListening ? 1.0 : 0.0;
                audioGainNode.connect(audioContext.destination);
                
                // Script processor to queue PCM for playback
                audioScriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);
                audioScriptProcessor._queue = [];
                audioScriptProcessor.onaudioprocess = function(e) {
                    const output = e.outputBuffer.getChannelData(0);
                    const queue = audioScriptProcessor._queue;
                    let written = 0;
                    while (written < output.length && queue.length > 0) {
                        const chunk = queue[0];
                        const available = chunk.length - (chunk._offset || 0);
                        const needed = output.length - written;
                        const take = Math.min(available, needed);
                        output.set(chunk.subarray(chunk._offset || 0, (chunk._offset || 0) + take), written);
                        written += take;
                        chunk._offset = (chunk._offset || 0) + take;
                        if (chunk._offset >= chunk.length) queue.shift();
                    }
                    // Fill remaining with silence
                    for (let i = written; i < output.length; i++) output[i] = 0;
                };
                audioScriptProcessor.connect(analyserNode);
                audioScriptProcessor.connect(audioGainNode);
                
                // Connect to audio WebSocket
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/audio`;
                
                audioWs = new WebSocket(wsUrl);
                audioWs.binaryType = 'arraybuffer';
                
                audioWs.onopen = function() {
                    console.log('Audio WebSocket connected');
                    waterfallRunning = true;
                    updateWaterfallStatus('● STREAMING', 'var(--lcars-green)');
                    updateStreamStatus('STREAMING');
                    
                    // Update button
                    const btn = document.getElementById('waterfallPlayButton');
                    btn.innerHTML = '⏸ STOP WATERFALL';
                    btn.className = 'btn danger';
                    
                    // Start animation loop
                    requestAnimationFrame(renderWaterfall);
                };
                
                audioWs.onmessage = function(event) {
                    if (event.data instanceof ArrayBuffer) {
                        processAudioData(event.data);
                    }
                };
                
                audioWs.onclose = function() {
                    console.log('Audio WebSocket disconnected');
                    stopWaterfall();
                };
                
                audioWs.onerror = function(error) {
                    console.error('Audio WebSocket error:', error);
                    stopWaterfall();
                };
                
            } catch (error) {
                console.error('Failed to start waterfall:', error);
                updateWaterfallStatus('● ERROR', 'var(--lcars-red)');
            }
        }
        
        function stopWaterfall() {
            waterfallRunning = false;
            
            if (audioWs) {
                audioWs.close();
                audioWs = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            updateWaterfallStatus('● OFFLINE', 'var(--lcars-red)');
            updateStreamStatus('STOPPED');
            
            // Update button
            const btn = document.getElementById('waterfallPlayButton');
            btn.innerHTML = '▶ START WATERFALL';
            btn.className = 'btn success';
            
            console.log('Waterfall stopped');
        }
        
        function processAudioData(arrayBuffer) {
            // Convert raw PCM to Float32Array for Web Audio API
            const int16Array = new Int16Array(arrayBuffer);
            const float32Array = new Float32Array(int16Array.length);
            
            // Convert and calculate audio level
            let maxSample = 0;
            for (let i = 0; i < int16Array.length; i++) {
                float32Array[i] = int16Array[i] / 32768.0; // Convert to -1.0 to 1.0
                maxSample = Math.max(maxSample, Math.abs(float32Array[i]));
            }
            
            // Update audio level
            audioLevel = maxSample;
            updateAudioLevel();
            
            // Queue audio for playback + FFT analysis
            if (audioContext && audioScriptProcessor) {
                // Queue for playback (keep max ~1 second buffered)
                const q = audioScriptProcessor._queue;
                q.push(float32Array);
                while (q.length > 12) q.shift(); // ~12 chunks = ~1s at 4096/48000
                
                // Get frequency data from analyser
                const bufferLength = analyserNode.frequencyBinCount;
                if (!frequencyData) {
                    frequencyData = new Uint8Array(bufferLength);
                }
                analyserNode.getByteFrequencyData(frequencyData);
                
                // Add to waterfall data
                addWaterfallLine(frequencyData);
            }
        }
        
        function addWaterfallLine(fftData) {
            // Apply zoom and create waterfall line
            const zoomedData = applyZoom(fftData);
            waterfallData.push(zoomedData);
            
            // Keep only necessary lines based on canvas height and scroll speed
            const maxLines = Math.ceil(waterfallConfig.canvasHeight / waterfallConfig.scrollSpeed) + 10;
            if (waterfallData.length > maxLines) {
                waterfallData.shift();
            }
        }
        
        function applyZoom(fftData) {
            if (waterfallConfig.zoomLevel === 1) {
                return Array.from(fftData);
            }
            
            // Zoom into center portion of spectrum
            const totalBins = fftData.length;
            const zoomBins = Math.floor(totalBins / waterfallConfig.zoomLevel);
            const startBin = Math.floor((totalBins - zoomBins) / 2);
            
            return Array.from(fftData.slice(startBin, startBin + zoomBins));
        }
        
        function renderWaterfall() {
            if (!waterfallRunning || !waterfallCtx) return;
            
            const canvas = waterfallCanvas;
            const ctx = waterfallCtx;
            const width = canvas.width;
            const height = canvas.height;
            const spectrumHeight = Math.floor(height * 0.25); // Top 25% = spectrum analyzer
            const waterfallTop = spectrumHeight;
            const waterfallHeight = height - spectrumHeight;
            
            // Scroll waterfall portion down
            if (waterfallHeight > waterfallConfig.scrollSpeed) {
                const imgData = ctx.getImageData(0, waterfallTop, width, waterfallHeight - waterfallConfig.scrollSpeed);
                ctx.putImageData(imgData, 0, waterfallTop + waterfallConfig.scrollSpeed);
            }
            
            // Draw new waterfall line
            if (waterfallData.length > 0) {
                const latestData = waterfallData[waterfallData.length - 1];
                drawWaterfallLine(ctx, latestData, waterfallTop, width);
                
                // Draw spectrum analyzer (top section)
                ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                ctx.fillRect(0, 0, width, spectrumHeight);
                
                // Grid lines
                ctx.strokeStyle = 'rgba(255, 168, 0, 0.12)';
                ctx.lineWidth = 1;
                for (let g = 0; g < 5; g++) {
                    const gy = spectrumHeight * (1 - g / 4) * 0.9 + spectrumHeight * 0.05;
                    ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(width, gy); ctx.stroke();
                }
                
                // Spectrum fill (semi-transparent)
                const grad = ctx.createLinearGradient(0, spectrumHeight, 0, 0);
                grad.addColorStop(0, 'rgba(0, 100, 200, 0.1)');
                grad.addColorStop(0.5, 'rgba(0, 200, 100, 0.15)');
                grad.addColorStop(1, 'rgba(200, 50, 50, 0.2)');
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.moveTo(0, spectrumHeight);
                for (let x = 0; x < width; x++) {
                    const binIndex = Math.floor((x / width) * latestData.length);
                    const val = (latestData[binIndex] || 0) / 255.0;
                    const y = spectrumHeight - val * spectrumHeight * 0.9;
                    ctx.lineTo(x, y);
                }
                ctx.lineTo(width, spectrumHeight);
                ctx.closePath();
                ctx.fill();
                
                // Spectrum line (bright)
                ctx.strokeStyle = 'rgba(100, 220, 255, 0.9)';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                for (let x = 0; x < width; x++) {
                    const binIndex = Math.floor((x / width) * latestData.length);
                    const val = (latestData[binIndex] || 0) / 255.0;
                    const y = spectrumHeight - val * spectrumHeight * 0.9;
                    if (x === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.stroke();
                
                // Center frequency marker
                ctx.strokeStyle = 'rgba(0, 255, 0, 0.4)';
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 4]);
                ctx.beginPath();
                ctx.moveTo(width / 2, 0);
                ctx.lineTo(width / 2, spectrumHeight);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            requestAnimationFrame(renderWaterfall);
        }
        
        function drawWaterfallLine(ctx, fftData, y, width) {
            const imageData = ctx.createImageData(width, waterfallConfig.scrollSpeed);
            const data = imageData.data;
            
            for (let x = 0; x < width; x++) {
                const binIndex = Math.floor((x / width) * fftData.length);
                const intensity = fftData[binIndex] || 0;
                const color = getWaterfallColor(intensity);
                
                for (let dy = 0; dy < waterfallConfig.scrollSpeed; dy++) {
                    const pixelIndex = ((y + dy) * width + x) * 4;
                    data[pixelIndex] = color.r;     // Red
                    data[pixelIndex + 1] = color.g; // Green
                    data[pixelIndex + 2] = color.b; // Blue
                    data[pixelIndex + 3] = 255;     // Alpha
                }
            }
            
            ctx.putImageData(imageData, 0, y);
        }
        
        // Pre-computed color lookup tables for speed (256 entries each)
        const waterfallColorLUTs = {};
        
        function buildColorLUT(palette) {
            const lut = new Array(256);
            for (let i = 0; i < 256; i++) {
                const n = i / 255.0;
                switch (palette) {
                    case 'radio': // FT-991A style: dark blue → blue → cyan → green → yellow → red → white
                        if (n < 0.1) {
                            lut[i] = {r: 0, g: 0, b: Math.floor(n * 10 * 80)};
                        } else if (n < 0.25) {
                            const t = (n - 0.1) / 0.15;
                            lut[i] = {r: 0, g: 0, b: 80 + Math.floor(t * 175)};
                        } else if (n < 0.4) {
                            const t = (n - 0.25) / 0.15;
                            lut[i] = {r: 0, g: Math.floor(t * 255), b: 255};
                        } else if (n < 0.55) {
                            const t = (n - 0.4) / 0.15;
                            lut[i] = {r: 0, g: 255, b: 255 - Math.floor(t * 255)};
                        } else if (n < 0.7) {
                            const t = (n - 0.55) / 0.15;
                            lut[i] = {r: Math.floor(t * 255), g: 255, b: 0};
                        } else if (n < 0.85) {
                            const t = (n - 0.7) / 0.15;
                            lut[i] = {r: 255, g: 255 - Math.floor(t * 200), b: 0};
                        } else {
                            const t = (n - 0.85) / 0.15;
                            lut[i] = {r: 255, g: 55 + Math.floor(t * 200), b: Math.floor(t * 255)};
                        }
                        break;
                    case 'amber': // LCARS amber: black → deep orange → amber → gold → white
                        if (n < 0.3) {
                            const t = n / 0.3;
                            lut[i] = {r: Math.floor(t * 180), g: Math.floor(t * 80), b: 0};
                        } else if (n < 0.6) {
                            const t = (n - 0.3) / 0.3;
                            lut[i] = {r: 180 + Math.floor(t * 75), g: 80 + Math.floor(t * 120), b: Math.floor(t * 50)};
                        } else {
                            const t = (n - 0.6) / 0.4;
                            lut[i] = {r: 255, g: 200 + Math.floor(t * 55), b: 50 + Math.floor(t * 205)};
                        }
                        break;
                    case 'blue': // Deep blue → electric blue → cyan → white
                        if (n < 0.33) {
                            const t = n / 0.33;
                            lut[i] = {r: 0, g: Math.floor(t * 50), b: Math.floor(t * 200)};
                        } else if (n < 0.66) {
                            const t = (n - 0.33) / 0.33;
                            lut[i] = {r: Math.floor(t * 50), g: 50 + Math.floor(t * 200), b: 200 + Math.floor(t * 55)};
                        } else {
                            const t = (n - 0.66) / 0.34;
                            lut[i] = {r: 50 + Math.floor(t * 205), g: 250 + Math.floor(t * 5), b: 255};
                        }
                        break;
                    case 'green': // Matrix green
                        if (n < 0.5) {
                            const t = n / 0.5;
                            lut[i] = {r: 0, g: Math.floor(t * 200), b: Math.floor(t * 50)};
                        } else {
                            const t = (n - 0.5) / 0.5;
                            lut[i] = {r: Math.floor(t * 150), g: 200 + Math.floor(t * 55), b: 50 + Math.floor(t * 100)};
                        }
                        break;
                    case 'gray':
                    default:
                        lut[i] = {r: i, g: i, b: i};
                }
            }
            return lut;
        }
        
        // Pre-build all LUTs
        ['radio', 'amber', 'blue', 'green', 'gray'].forEach(p => { waterfallColorLUTs[p] = buildColorLUT(p); });
        
        function getWaterfallColor(intensity) {
            const idx = Math.min(255, Math.max(0, Math.floor(intensity)));
            const lut = waterfallColorLUTs[waterfallConfig.colorPalette] || waterfallColorLUTs['radio'];
            return lut[idx];
        }
        
        function updateWaterfallStatus(text, color) {
            const status = document.getElementById('waterfallStatus');
            if (status) {
                status.textContent = text;
                status.style.color = color;
            }
        }
        
        function updateStreamStatus(status) {
            const element = document.getElementById('streamStatus');
            if (element) {
                element.textContent = status;
                element.className = status === 'STREAMING' ? 'status-value active' : 'status-value';
            }
        }
        
        function updateAudioLevel() {
            const levelDb = audioLevel > 0 ? 20 * Math.log10(audioLevel) : -Infinity;
            const levelPercent = Math.max(0, Math.min(100, (levelDb + 60) / 60 * 100));
            
            document.getElementById('audioLevelValue').textContent = 
                levelDb === -Infinity ? '-∞ dB' : `${levelDb.toFixed(1)} dB`;
            document.getElementById('audioLevelBar').style.width = `${levelPercent}%`;
        }
        
        function handleWaterfallClick(event) {
            // Calculate frequency from click position
            const rect = waterfallCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const clickRatio = x / rect.width;
            
            // Calculate frequency based on sample rate and zoom
            const sampleRate = 48000;
            const nyquist = sampleRate / 2;
            const bandwidth = nyquist / waterfallConfig.zoomLevel;
            const clickedFreq = clickRatio * bandwidth;
            
            console.log(`Waterfall click: ${clickedFreq.toFixed(0)} Hz offset`);
            // TODO: Implement frequency tuning based on click
        }
        
        // Control functions
        function updateZoom(value) {
            waterfallConfig.zoomLevel = parseFloat(value);
            document.getElementById('zoomValue').textContent = `${value}x`;
        }
        
        function updateSpeed(value) {
            waterfallConfig.scrollSpeed = parseInt(value);
            document.getElementById('speedValue').textContent = value;
        }
        
        function setFFTSize(size) {
            waterfallConfig.fftSize = size;
            document.getElementById('fftSizeDisplay').textContent = size.toString();
            
            // Update analyser if running
            if (analyserNode) {
                analyserNode.fftSize = size;
            }
            
            // Update button states
            document.querySelectorAll('.selector-btn').forEach(btn => {
                if (btn.textContent === size.toString()) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        function setColorPalette(palette) {
            waterfallConfig.colorPalette = palette;
            
            // Update button states
            document.querySelectorAll('.selector-btn').forEach(btn => {
                const btnText = btn.textContent.toLowerCase();
                if ((palette === 'amber' && btnText === 'amber') ||
                    (palette === 'blue' && btnText === 'blue') ||
                    (palette === 'green' && btnText === 'green') ||
                    (palette === 'gray' && btnText === 'gray')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        function updateCanvasHeight(value) {
            const height = parseInt(value);
            waterfallConfig.canvasHeight = height;
            waterfallCanvas.style.height = `${height}px`;
            waterfallCanvas.height = height;
            document.getElementById('heightValue').textContent = `${height}px`;
        }

        // ── Memory Channel Management ───────────────────────────
        let memoryChannels = {};  // Store memory channel data
        
        async function scanMemoryChannels() {
            if (!radio_connected) {
                alert('Radio not connected. Please connect to radio first.');
                return;
            }
            
            const loadingMsg = document.getElementById('memoryLoadingMsg');
            const scanBtn = document.getElementById('scanMemoryBtn');
            
            // Show loading state
            loadingMsg.innerHTML = 'Scanning memory channels... <br><small>Reading MR001; through MR099; from radio</small>';
            scanBtn.disabled = true;
            scanBtn.textContent = 'SCANNING...';
            
            try {
                const response = await fetch('/api/memory/list', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                memoryChannels = data.channels || {};
                
                displayMemoryChannels();
                updateMemoryStats();
                updateLastMemoryOp('Memory scan completed');
                
                console.log('Memory scan completed:', Object.keys(memoryChannels).length, 'channels');
                
            } catch (error) {
                console.error('Memory scan failed:', error);
                loadingMsg.innerHTML = `<span style="color: var(--lcars-red);">Scan failed: ${error.message}</span>`;
                logError('Memory scan failed: ' + error.message);
            } finally {
                scanBtn.disabled = false;
                scanBtn.textContent = 'SCAN ALL MEMORIES';
            }
        }
        
        function displayMemoryChannels() {
            const list = document.getElementById('memoryChannelList');
            const loadingMsg = document.getElementById('memoryLoadingMsg');
            
            // Hide loading message
            loadingMsg.style.display = 'none';
            
            let html = '';
            let programmedCount = 0;
            
            // Generate all 99 channels
            for (let i = 1; i <= 99; i++) {
                const channel = i.toString().padStart(3, '0');
                const memory = memoryChannels[channel];
                
                if (memory && memory.frequency > 0) {
                    // Programmed memory
                    programmedCount++;
                    const freqMHz = (memory.frequency / 1000000).toFixed(6);
                    const isCurrent = memory.is_current || false;
                    
                    html += `
                        <div class="memory-item ${isCurrent ? 'current' : ''}" onclick="showMemoryDetails('${channel}')">
                            <div class="memory-channel">${channel}</div>
                            <div class="memory-frequency">${freqMHz}</div>
                            <div class="memory-mode">${memory.mode || 'UNK'}</div>
                            <div class="memory-label">${memory.label || '-'}</div>
                            <div class="memory-actions">
                                <button class="memory-action-btn recall" onclick="event.stopPropagation(); recallMemoryByChannel('${channel}')" 
                                        title="Recall memory channel ${channel} to VFO-A">RCL</button>
                                <button class="memory-action-btn delete" onclick="event.stopPropagation(); deleteMemoryByChannel('${channel}')"
                                        title="Delete memory channel ${channel}">DEL</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Empty memory slot
                    html += `
                        <div class="memory-item empty" onclick="showMemoryDetails('${channel}')">
                            <div class="memory-channel">${channel}</div>
                            <div class="memory-frequency">---.------</div>
                            <div class="memory-mode">---</div>
                            <div class="memory-label">Empty</div>
                            <div class="memory-actions">
                                <button class="memory-action-btn" onclick="event.stopPropagation(); storeToMemoryByChannel('${channel}')"
                                        title="Store current VFO-A to memory channel ${channel}">STORE</button>
                            </div>
                        </div>
                    `;
                }
            }
            
            list.innerHTML = html;
            
            // Update programmed count
            document.getElementById('programmedChannels').textContent = programmedCount;
        }
        
        function updateMemoryStats() {
            const programmed = Object.keys(memoryChannels).filter(ch => 
                memoryChannels[ch] && memoryChannels[ch].frequency > 0
            ).length;
            
            document.getElementById('programmedChannels').textContent = programmed;
            
            // Update current memory display
            const currentCh = Object.keys(memoryChannels).find(ch => 
                memoryChannels[ch] && memoryChannels[ch].is_current
            );
            document.getElementById('currentMemoryChannel').textContent = currentCh || '-';
        }
        
        function updateLastMemoryOp(operation) {
            document.getElementById('lastMemoryOp').textContent = operation;
        }
        
        function refreshMemoryDisplay() {
            if (Object.keys(memoryChannels).length > 0) {
                displayMemoryChannels();
                updateMemoryStats();
                updateLastMemoryOp('Display refreshed');
            } else {
                document.getElementById('memoryLoadingMsg').innerHTML = 
                    'No memory data loaded. Click "SCAN ALL MEMORIES" first.';
            }
        }
        
        async function recallMemoryChannel() {
            const channelNum = document.getElementById('recallChannelNum').value;
            if (!channelNum) {
                alert('Please enter a memory channel number (001-099)');
                return;
            }
            
            await recallMemoryByChannel(channelNum.padStart(3, '0'));
        }
        
        async function recallMemoryByChannel(channel) {
            if (!radio_connected) {
                alert('Radio not connected');
                return;
            }
            
            try {
                const response = await fetch('/api/memory/recall', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channel: parseInt(channel) })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateLastMemoryOp(`Recalled memory ${channel}`);
                console.log('Memory recalled:', data);
                
                // Update current memory indicator
                Object.values(memoryChannels).forEach(mem => mem.is_current = false);
                if (memoryChannels[channel]) {
                    memoryChannels[channel].is_current = true;
                }
                displayMemoryChannels();
                
            } catch (error) {
                console.error('Memory recall failed:', error);
                alert(`Memory recall failed: ${error.message}`);
                logError('Memory recall failed: ' + error.message);
            }
        }
        
        async function storeToMemoryChannel() {
            const channelNum = document.getElementById('storeChannelNum').value;
            if (!channelNum) {
                alert('Please enter a memory channel number (001-099)');
                return;
            }
            
            await storeToMemoryByChannel(channelNum.padStart(3, '0'));
        }
        
        async function storeToMemoryByChannel(channel) {
            if (!radio_connected) {
                alert('Radio not connected');
                return;
            }
            
            if (!radioStatus.frequency_a) {
                alert('No VFO-A frequency available');
                return;
            }
            
            const confirm = window.confirm(
                `Store current VFO-A to memory ${channel}?\n\n` +
                `Frequency: ${formatFrequencyPrecise(radioStatus.frequency_a)}\n` +
                `Mode: ${radioStatus.mode}\n\n` +
                `This will overwrite any existing data in channel ${channel}.`
            );
            
            if (!confirm) return;
            
            try {
                const response = await fetch('/api/memory/store', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channel: parseInt(channel) })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateLastMemoryOp(`Stored to memory ${channel}`);
                console.log('Memory stored:', data);
                
                // Update local memory data
                memoryChannels[channel] = {
                    frequency: radioStatus.frequency_a,
                    mode: radioStatus.mode,
                    label: '',
                    is_current: false
                };
                
                displayMemoryChannels();
                updateMemoryStats();
                
            } catch (error) {
                console.error('Memory store failed:', error);
                alert(`Memory store failed: ${error.message}`);
                logError('Memory store failed: ' + error.message);
            }
        }
        
        async function clearMemoryChannel() {
            const channelNum = document.getElementById('recallChannelNum').value || 
                             document.getElementById('storeChannelNum').value;
            if (!channelNum) {
                alert('Please enter a memory channel number to clear');
                return;
            }
            
            await deleteMemoryByChannel(channelNum.padStart(3, '0'));
        }
        
        async function deleteMemoryByChannel(channel) {
            if (!radio_connected) {
                alert('Radio not connected');
                return;
            }
            
            const memory = memoryChannels[channel];
            if (!memory || memory.frequency <= 0) {
                alert(`Memory channel ${channel} is already empty`);
                return;
            }
            
            const confirm = window.confirm(
                `Delete memory channel ${channel}?\n\n` +
                `Frequency: ${(memory.frequency / 1000000).toFixed(6)} MHz\n` +
                `Mode: ${memory.mode}\n\n` +
                `This cannot be undone.`
            );
            
            if (!confirm) return;
            
            try {
                const response = await fetch('/api/memory/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channel: parseInt(channel) })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateLastMemoryOp(`Cleared memory ${channel}`);
                console.log('Memory cleared:', data);
                
                // Update local memory data
                delete memoryChannels[channel];
                displayMemoryChannels();
                updateMemoryStats();
                
            } catch (error) {
                console.error('Memory clear failed:', error);
                alert(`Memory clear failed: ${error.message}`);
                logError('Memory clear failed: ' + error.message);
            }
        }
        
        function showMemoryDetails(channel) {
            const memory = memoryChannels[channel];
            const panel = document.getElementById('memoryDetailsPanel');
            
            // Update detail fields
            document.getElementById('detailChannelNum').textContent = channel;
            
            if (memory && memory.frequency > 0) {
                document.getElementById('detailFrequency').textContent = 
                    `${(memory.frequency / 1000000).toFixed(6)} MHz`;
                document.getElementById('detailMode').textContent = memory.mode || 'Unknown';
                document.getElementById('detailCtcss').textContent = memory.ctcss || 'OFF';
                document.getElementById('detailLabel').textContent = memory.label || '-';
            } else {
                document.getElementById('detailFrequency').textContent = 'Empty';
                document.getElementById('detailMode').textContent = '-';
                document.getElementById('detailCtcss').textContent = '-';
                document.getElementById('detailLabel').textContent = '-';
            }
            
            // Show panel
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth' });
            
            // Store current channel for detail operations
            panel.dataset.channel = channel;
        }
        
        function hideMemoryDetails() {
            document.getElementById('memoryDetailsPanel').style.display = 'none';
        }
        
        function recallDetailedChannel() {
            const channel = document.getElementById('memoryDetailsPanel').dataset.channel;
            recallMemoryByChannel(channel);
        }
        
        function updateDetailedChannel() {
            const channel = document.getElementById('memoryDetailsPanel').dataset.channel;
            storeToMemoryByChannel(channel);
        }
        
        function deleteDetailedChannel() {
            const channel = document.getElementById('memoryDetailsPanel').dataset.channel;
            deleteMemoryByChannel(channel);
        }
        
        function copyMemoryChannel() {
            const fromCh = prompt('Copy FROM memory channel (001-099):');
            const toCh = prompt('Copy TO memory channel (001-099):');
            
            if (!fromCh || !toCh) return;
            
            const fromChannel = fromCh.padStart(3, '0');
            const toChannel = toCh.padStart(3, '0');
            
            const fromMemory = memoryChannels[fromChannel];
            if (!fromMemory || fromMemory.frequency <= 0) {
                alert(`Source memory channel ${fromChannel} is empty`);
                return;
            }
            
            const confirm = window.confirm(
                `Copy memory ${fromChannel} to ${toChannel}?\n\n` +
                `From: ${(fromMemory.frequency / 1000000).toFixed(6)} MHz ${fromMemory.mode}\n` +
                `To: Channel ${toChannel}\n\n` +
                `This will overwrite channel ${toChannel} if it contains data.`
            );
            
            if (!confirm) return;
            
            // Copy memory data locally
            memoryChannels[toChannel] = { ...fromMemory };
            memoryChannels[toChannel].is_current = false;
            
            displayMemoryChannels();
            updateMemoryStats();
            updateLastMemoryOp(`Copied ${fromChannel} → ${toChannel}`);
            
            alert(`Memory ${fromChannel} copied to ${toChannel}\n\nNote: This is a local copy. Use STORE to write to radio.`);
        }
        
        // Update current VFO display for memory operations
        function updateVfoForMemory() {
            if (radioStatus) {
                const freqElem = document.getElementById('currentVfoFreq');
                const modeElem = document.getElementById('currentVfoMode');
                
                if (freqElem && radioStatus.frequency_a) {
                    freqElem.textContent = formatFrequencyPrecise(radioStatus.frequency_a);
                }
                
                if (modeElem && radioStatus.mode) {
                    modeElem.textContent = radioStatus.mode;
                }
            }
        }

        // ── Scanner Functions ───────────────────────────────────
        let scanActive = false;
        let scanStartFreq = 0;
        let scanEndFreq = 0;
        let scanStep = 5000; // Default 5 kHz
        let squelchThreshold = 50; // S3 equivalent
        let scanResults = [];
        let currentScanFreq = 0;
        let scanCount = 0;
        let scanActiveCount = 0;

        function selectBandRange(startHz, endHz) {
            document.getElementById('scanStartFreq').value = startHz;
            document.getElementById('scanEndFreq').value = endHz;
            updateScanRangeDisplay(startHz, endHz);
            
            // Update active button
            document.querySelectorAll('#scanner .selector-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function setScanStep(stepHz) {
            scanStep = stepHz;
            document.getElementById('scanStepDisplay').textContent = formatFrequencyStep(stepHz);
            
            // Update active button
            document.querySelectorAll('[data-step]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-step="${stepHz}"]`).classList.add('active');
        }

        function updateSquelchThreshold(value) {
            squelchThreshold = parseInt(value);
            const sUnit = convertToSUnit(value);
            document.getElementById('squelchValue').textContent = sUnit;
            document.getElementById('scanThresholdDisplay').textContent = sUnit;
        }

        function convertToSUnit(rawValue) {
            // Convert 0-255 raw value to S-unit display
            const scaled = parseInt(rawValue);
            if (scaled < 20) return 'S0';
            if (scaled < 40) return 'S1';
            if (scaled < 60) return 'S2';
            if (scaled < 80) return 'S3';
            if (scaled < 100) return 'S4';
            if (scaled < 120) return 'S5';
            if (scaled < 140) return 'S6';
            if (scaled < 160) return 'S7';
            if (scaled < 180) return 'S8';
            if (scaled < 200) return 'S9';
            return `S9+${Math.round((scaled - 200) / 10)}`;
        }

        function formatFrequencyStep(hz) {
            if (hz >= 1000000) {
                return `${hz / 1000000} MHz`;
            } else if (hz >= 1000) {
                return `${hz / 1000} kHz`;
            } else {
                return `${hz} Hz`;
            }
        }

        function updateScanRangeDisplay(startHz, endHz) {
            const startMhz = (startHz / 1000000).toFixed(3);
            const endMhz = (endHz / 1000000).toFixed(3);
            document.getElementById('scanRangeDisplay').textContent = `${startMhz} - ${endMhz} MHz`;
        }

        async function toggleScan() {
            if (scanActive) {
                await stopScan();
            } else {
                await startScan();
            }
        }

        async function startScan() {
            const startFreq = parseInt(document.getElementById('scanStartFreq').value);
            const endFreq = parseInt(document.getElementById('scanEndFreq').value);
            
            if (!startFreq || !endFreq || startFreq >= endFreq) {
                alert('Please enter valid start and end frequencies');
                return;
            }
            
            if (startFreq < 30000 || endFreq > 470000000) {
                alert('Frequency range must be between 30 kHz and 470 MHz');
                return;
            }

            scanActive = true;
            scanStartFreq = startFreq;
            scanEndFreq = endFreq;
            currentScanFreq = startFreq;
            scanCount = 0;
            scanActiveCount = 0;
            
            // Update UI
            document.getElementById('scanButton').innerHTML = '⏸ STOP SCAN';
            document.getElementById('scanButton').className = 'btn danger';
            document.getElementById('scanStatus').textContent = 'SCANNING';
            document.getElementById('scanStatus').className = 'status-value active';
            
            // Clear previous results if any
            clearScanResults();
            
            try {
                // Start scan via API
                const response = await apiCall('/scan', 'POST', {
                    start_freq: startFreq,
                    end_freq: endFreq,
                    step: scanStep,
                    threshold: squelchThreshold
                });
                
                if (!response.success) {
                    throw new Error(response.error || 'Scan failed to start');
                }
                
                logError(`Scan started: ${formatFrequencyPrecise(startFreq)} - ${formatFrequencyPrecise(endFreq)}, step ${formatFrequencyStep(scanStep)}`);
                
            } catch (error) {
                console.error('Failed to start scan:', error);
                logError('Scan start failed: ' + error.message);
                await stopScan();
            }
        }

        async function stopScan() {
            scanActive = false;
            
            try {
                await apiCall('/scan/stop', 'POST');
            } catch (error) {
                console.error('Failed to stop scan:', error);
            }
            
            // Update UI
            document.getElementById('scanButton').innerHTML = '▶ START SCAN';
            document.getElementById('scanButton').className = 'btn primary';
            document.getElementById('scanStatus').textContent = 'STOPPED';
            document.getElementById('scanStatus').className = 'status-value';
            document.getElementById('scanProgress').textContent = '100%';
            document.getElementById('scanProgressBar').style.width = '100%';
            document.getElementById('scanCurrentFreq').textContent = '---';
            document.getElementById('scanETA').textContent = '---';
            
            logError('Scan stopped');
        }

        function handleScanProgress(data) {
            if (!scanActive) return;
            
            // Update current frequency
            currentScanFreq = data.frequency;
            document.getElementById('scanCurrentFreq').textContent = formatFrequencyPrecise(data.frequency);
            
            // Update progress
            const progress = ((data.frequency - scanStartFreq) / (scanEndFreq - scanStartFreq)) * 100;
            document.getElementById('scanProgress').textContent = `${Math.round(progress)}%`;
            document.getElementById('scanProgressBar').style.width = `${progress}%`;
            
            // Update scan count
            scanCount++;
            document.getElementById('scanCount').textContent = scanCount;
            
            // Calculate ETA
            if (scanCount > 10) { // Only show ETA after a few samples
                const elapsed = (Date.now() - scanStartTime) / 1000; // seconds
                const rate = scanCount / elapsed; // scans per second
                const remaining = (scanEndFreq - data.frequency) / scanStep;
                const eta = remaining / rate;
                document.getElementById('scanETA').textContent = formatTime(eta);
            }
            
            // Check if this frequency has activity
            if (data.s_meter >= squelchThreshold) {
                scanActiveCount++;
                document.getElementById('scanActiveCount').textContent = scanActiveCount;
                
                // Add to results table
                addScanResult(data.frequency, data.s_meter, data.mode || 'AUTO', true);
                
                logError(`Active signal found: ${formatFrequencyPrecise(data.frequency)} - ${convertToSUnit(data.s_meter)}`);
            }
        }

        function addScanResult(frequency, sMeter, mode, isActive) {
            const tableBody = document.getElementById('scanResultsTable');
            
            // Remove "no results" message if present
            if (tableBody.querySelector('td[colspan="5"]')) {
                tableBody.innerHTML = '';
            }
            
            // Create new row
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.style.transition = 'background-color 0.2s';
            
            if (isActive) {
                row.style.backgroundColor = 'rgba(153, 221, 102, 0.1)'; // Green highlight for active
                row.style.borderLeft = '4px solid var(--lcars-green)';
            }
            
            // Add hover effect
            row.addEventListener('mouseenter', () => {
                row.style.backgroundColor = 'rgba(255, 204, 102, 0.2)';
            });
            
            row.addEventListener('mouseleave', () => {
                row.style.backgroundColor = isActive ? 'rgba(153, 221, 102, 0.1)' : 'transparent';
            });
            
            // Click to tune radio
            row.addEventListener('click', () => {
                tuneToFrequency(frequency);
            });
            
            row.innerHTML = `
                <td style="padding: 0.75rem; border-bottom: 1px solid var(--lcars-teal);">
                    <span style="font-family: 'Antonio', monospace; font-weight: 600; color: var(--lcars-gold);">
                        ${formatFrequencyPrecise(frequency)}
                    </span>
                    <div style="font-size: 0.7rem; color: var(--lcars-peach);">${(frequency / 1000000).toFixed(3)} MHz</div>
                </td>
                <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--lcars-teal);">
                    <span style="font-weight: 600; color: ${isActive ? 'var(--lcars-green)' : 'var(--lcars-text)'};">
                        ${convertToSUnit(sMeter)}
                    </span>
                </td>
                <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--lcars-teal);">
                    <span style="font-size: 0.8rem; color: var(--lcars-peach);">${mode}</span>
                </td>
                <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--lcars-teal);">
                    <span style="color: ${isActive ? 'var(--lcars-green)' : 'var(--lcars-text)'};">
                        ${isActive ? '● ACTIVE' : '○ QUIET'}
                    </span>
                </td>
                <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--lcars-teal);">
                    <button class="btn btn-small" onclick="tuneToFrequency(${frequency})" title="Tune radio to this frequency">
                        TUNE
                    </button>
                </td>
            `;
            
            // Insert at top of table (most recent first)
            tableBody.insertBefore(row, tableBody.firstChild);
            
            // Keep only last 100 results
            while (tableBody.children.length > 100) {
                tableBody.removeChild(tableBody.lastChild);
            }
            
            // Store in results array
            scanResults.unshift({
                frequency,
                sMeter,
                mode,
                isActive,
                timestamp: Date.now()
            });
            
            // Keep only last 100 results in memory
            if (scanResults.length > 100) {
                scanResults = scanResults.slice(0, 100);
            }
        }

        async function tuneToFrequency(frequency) {
            try {
                await apiCall('/frequency/a', 'POST', { frequency: frequency });
                logError(`Tuned to ${formatFrequencyPrecise(frequency)}`);
                
                // Briefly highlight the frequency in VFO display
                const freqDisplay = document.getElementById('frequencyA');
                if (freqDisplay) {
                    freqDisplay.style.textShadow = '0 0 20px var(--lcars-green)';
                    setTimeout(() => {
                        freqDisplay.style.textShadow = '0 0 10px var(--lcars-gold)';
                    }, 1000);
                }
            } catch (error) {
                console.error('Failed to tune to frequency:', error);
                logError('Tune failed: ' + error.message);
            }
        }

        function clearScanResults() {
            const tableBody = document.getElementById('scanResultsTable');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="padding: 2rem; text-align: center; color: var(--lcars-peach); font-style: italic;">
                        No scan results yet. Start a scan to see active frequencies.
                    </td>
                </tr>
            `;
            scanResults = [];
            scanActiveCount = 0;
            document.getElementById('scanActiveCount').textContent = '0';
        }

        function exportScanResults() {
            if (scanResults.length === 0) {
                alert('No scan results to export');
                return;
            }
            
            let csv = 'Frequency (Hz),Frequency (MHz),S-Meter,S-Unit,Mode,Status,Timestamp\n';
            
            scanResults.forEach(result => {
                const freqMhz = (result.frequency / 1000000).toFixed(6);
                const sUnit = convertToSUnit(result.sMeter);
                const status = result.isActive ? 'ACTIVE' : 'QUIET';
                const timestamp = new Date(result.timestamp).toISOString();
                
                csv += `${result.frequency},${freqMhz},${result.sMeter},${sUnit},${result.mode},${status},${timestamp}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ft991a-scan-results-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            logError(`Exported ${scanResults.length} scan results to CSV`);
        }

        function scanActiveOnly() {
            const activeResults = scanResults.filter(result => result.isActive);
            
            if (activeResults.length === 0) {
                alert('No active frequencies found in previous scan results');
                return;
            }
            
            // Create a custom scan of only the active frequencies
            // This would need special backend support, for now just show a message
            logError(`Found ${activeResults.length} active frequencies for rescanning`);
            alert(`Found ${activeResults.length} active frequencies. This feature requires backend implementation.`);
        }

        function formatTime(seconds) {
            if (seconds < 60) {
                return `${Math.round(seconds)}s`;
            } else if (seconds < 3600) {
                return `${Math.round(seconds / 60)}m`;
            } else {
                return `${Math.round(seconds / 3600)}h`;
            }
        }

        // Scanner WebSocket message handler (add to existing handleWebSocketMessage function)
        function handleScanMessage(data) {
            switch (data.type) {
                case 'scan_progress':
                    handleScanProgress(data);
                    break;
                case 'scan_complete':
                    stopScan();
                    logError('Scan completed successfully');
                    break;
                case 'scan_error':
                    logError('Scan error: ' + data.message);
                    stopScan();
                    break;
            }
        }

        let scanStartTime = 0; // Track scan start time for ETA calculation

        // ── SDR Functions ───────────────────────────────────────
        function connectSDRWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/sdr`;
            
            sdrWs = new WebSocket(wsUrl);
            
            sdrWs.onopen = function() {
                console.log('SDR WebSocket connected');
                updateSDRConnectionStatus(true);
            };
            
            sdrWs.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleSDRMessage(data);
            };
            
            sdrWs.onclose = function() {
                console.log('SDR WebSocket disconnected');
                updateSDRConnectionStatus(false);
                // Attempt reconnection after 3 seconds
                setTimeout(connectSDRWebSocket, 3000);
            };
            
            sdrWs.onerror = function(error) {
                console.error('SDR WebSocket error:', error);
                updateSDRConnectionStatus(false);
                logError('SDR WebSocket error: ' + error.message);
            };
        }

        function handleSDRMessage(data) {
            switch(data.type) {
                case 'sdr_info':
                    updateSDRInfo(data);
                    break;
                case 'sdr_fft':
                    updateSDRWaterfall(data);
                    break;
                case 'sdr_error':
                    logError('SDR Error: ' + data.message);
                    updateSDRConnectionStatus(false);
                    break;
                case 'sdr_status':
                    updateSDRStatus(data);
                    break;
                case 'bandwidth_changed':
                    sdrConfig.bandwidth = data.bandwidth;
                    updateSDRBandwidthDisplay();
                    break;
                case 'fft_size_changed':
                    sdrConfig.fftSize = data.fft_size;
                    updateSDRFFTDisplay();
                    break;
                default:
                    console.log('Unknown SDR message type:', data.type);
            }
        }

        function updateSDRConnectionStatus(connected) {
            const status = document.getElementById('sdrWaterfallStatus');
            const deviceStatus = document.getElementById('sdrDeviceStatus');
            const streamStatus = document.getElementById('sdrStreamStatus');
            
            if (connected) {
                status.textContent = '● SDR ONLINE';
                status.style.color = 'var(--lcars-green)';
                if (deviceStatus) deviceStatus.textContent = 'CONNECTED';
                if (streamStatus) streamStatus.textContent = 'READY';
            } else {
                status.textContent = '● SDR OFFLINE';
                status.style.color = 'var(--lcars-red)';
                if (deviceStatus) deviceStatus.textContent = 'DISCONNECTED';
                if (streamStatus) streamStatus.textContent = 'STOPPED';
            }
        }

        function updateSDRInfo(data) {
            console.log('SDR Info:', data);
            
            // Update device status displays
            document.getElementById('sdrDeviceStatus').textContent = data.available ? 'AVAILABLE' : 'NOT AVAILABLE';
            document.getElementById('sdrSerial').textContent = data.serial || 'Unknown';
            document.getElementById('sdrDriver').textContent = data.driver || 'Unknown';
            
            // Update config
            sdrConfig.bandwidth = data.bandwidth || 2000000;
            sdrConfig.fftSize = data.fft_size || 1024;
            
            updateSDRBandwidthDisplay();
            updateSDRFFTDisplay();
        }

        function updateSDRWaterfall(data) {
            if (!sdrRunning || !sdrCtx) return;
            
            const bins = data.bins;
            const centerFreq = data.center_freq;
            const bandwidth = data.bandwidth;
            
            // Update center frequency display
            document.getElementById('sdrFreqDisplay').textContent = formatFrequencyPrecise(centerFreq);
            sdrConfig.centerFreq = centerFreq;
            
            // Convert FFT bins to waterfall line
            const canvasWidth = sdrCanvas.width;
            const imageData = sdrCtx.createImageData(canvasWidth, 1);
            
            for (let i = 0; i < canvasWidth; i++) {
                const binIndex = Math.floor((i / canvasWidth) * bins.length);
                const magnitude = bins[binIndex] || -100;  // dB
                
                // Normalize magnitude (-100 dB to -20 dB range)
                const normalizedMag = Math.max(0, Math.min(1, (magnitude + 100) / 80));
                
                // Apply color mapping
                const color = getSDRColor(normalizedMag);
                const pixelIndex = i * 4;
                imageData.data[pixelIndex] = color.r;
                imageData.data[pixelIndex + 1] = color.g;
                imageData.data[pixelIndex + 2] = color.b;
                imageData.data[pixelIndex + 3] = 255; // Alpha
            }
            
            // Scroll waterfall down
            const canvasHeight = sdrCanvas.height;
            const existingData = sdrCtx.getImageData(0, 0, canvasWidth, canvasHeight - 1);
            sdrCtx.putImageData(existingData, 0, 1);
            
            // Add new line at top
            sdrCtx.putImageData(imageData, 0, 0);
            
            // Update signal level indicator
            const maxSignal = Math.max(...bins);
            sdrSignalLevel = maxSignal;
            updateSDRSignalLevelDisplay(maxSignal);
            
            // Update radio frequency indicator
            updateSDRRadioFreqIndicator();
            
            // Update frequency axis labels
            updateSDRFreqAxisLabels();
        }

        function getSDRColor(magnitude) {
            // Color mapping based on selected palette
            const palette = sdrConfig.colorPalette;
            
            if (palette === 'radio') {
                // FT-991A style: Blue -> Cyan -> Green -> Yellow -> Red
                if (magnitude < 0.2) {
                    return { r: 0, g: 0, b: Math.floor(255 * magnitude * 5) };
                } else if (magnitude < 0.4) {
                    const t = (magnitude - 0.2) * 5;
                    return { r: 0, g: Math.floor(255 * t), b: 255 };
                } else if (magnitude < 0.6) {
                    const t = (magnitude - 0.4) * 5;
                    return { r: 0, g: 255, b: Math.floor(255 * (1 - t)) };
                } else if (magnitude < 0.8) {
                    const t = (magnitude - 0.6) * 5;
                    return { r: Math.floor(255 * t), g: 255, b: 0 };
                } else {
                    const t = (magnitude - 0.8) * 5;
                    return { r: 255, g: Math.floor(255 * (1 - t)), b: 0 };
                }
            } else {
                // Simple grayscale for other palettes for now
                const intensity = Math.floor(255 * magnitude);
                return { r: intensity, g: intensity, b: intensity };
            }
        }

        function updateSDRRadioFreqIndicator() {
            if (!radioStatus || !radioStatus.frequency_a) return;
            
            const radioFreq = radioStatus.frequency_a;
            const centerFreq = sdrConfig.centerFreq;
            const bandwidth = sdrConfig.bandwidth;
            
            const freqOffset = radioFreq - centerFreq;
            const maxOffset = bandwidth / 2;
            
            // Check if radio frequency is within SDR bandwidth
            if (Math.abs(freqOffset) <= maxOffset) {
                const canvasWidth = sdrCanvas.width;
                const position = (freqOffset / maxOffset) * (canvasWidth / 2) + (canvasWidth / 2);
                
                const indicator = document.getElementById('sdrRadioFreqLine');
                indicator.style.left = `${position + 1}rem`;
                indicator.style.display = 'block';
            } else {
                document.getElementById('sdrRadioFreqLine').style.display = 'none';
            }
        }

        function updateSDRFreqAxisLabels() {
            const axisDiv = document.getElementById('sdrFreqAxis');
            if (!axisDiv) return;
            
            const centerFreq = sdrConfig.centerFreq;
            const bandwidth = sdrConfig.bandwidth;
            const startFreq = centerFreq - bandwidth / 2;
            const endFreq = centerFreq + bandwidth / 2;
            
            // Clear existing labels
            axisDiv.innerHTML = '';
            
            // Add frequency labels
            const numLabels = 5;
            for (let i = 0; i < numLabels; i++) {
                const freq = startFreq + (bandwidth * i / (numLabels - 1));
                const position = (i / (numLabels - 1)) * 100;
                
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.left = `${position}%`;
                label.style.transform = 'translateX(-50%)';
                label.style.fontSize = '0.7rem';
                label.style.color = 'var(--lcars-peach)';
                label.style.textAlign = 'center';
                label.textContent = (freq / 1000000).toFixed(3);
                
                axisDiv.appendChild(label);
            }
        }

        function updateSDRSignalLevelDisplay(level) {
            const levelValue = document.getElementById('sdrSignalLevelValue');
            const levelBar = document.getElementById('sdrSignalLevelBar');
            
            if (levelValue) {
                levelValue.textContent = `${level.toFixed(1)} dB`;
            }
            
            if (levelBar) {
                // Convert dB to percentage (assume -100 dB to -20 dB range)
                const percentage = Math.max(0, Math.min(100, (level + 100) * 1.25));
                levelBar.style.width = `${percentage}%`;
            }
        }

        function toggleSDRWaterfall() {
            const button = document.getElementById('sdrStartButton');
            
            if (sdrRunning) {
                // Stop SDR
                sdrRunning = false;
                button.textContent = '▶ START SDR';
                button.classList.remove('danger');
                button.classList.add('success');
                document.getElementById('sdrStreamStatus').textContent = 'STOPPED';
                
                // Disconnect SDR WebSocket
                if (sdrWs) {
                    sdrWs.close();
                    sdrWs = null;
                }
            } else {
                // Start SDR
                sdrRunning = true;
                button.textContent = '⏹ STOP SDR';
                button.classList.remove('success');
                button.classList.add('danger');
                document.getElementById('sdrStreamStatus').textContent = 'STREAMING';
                
                // Initialize canvas if needed
                if (!sdrCanvas) {
                    initSDRWaterfall();
                }
                
                // Connect SDR WebSocket
                connectSDRWebSocket();
            }
        }

        function initSDRWaterfall() {
            sdrCanvas = document.getElementById('sdrWaterfallCanvas');
            if (sdrCanvas) {
                sdrCtx = sdrCanvas.getContext('2d');
                sdrCtx.fillStyle = '#000';
                sdrCtx.fillRect(0, 0, sdrCanvas.width, sdrCanvas.height);
                console.log('SDR waterfall initialized');
            }
        }

        function setSDRBandwidth(bandwidth, button) {
            sdrConfig.bandwidth = bandwidth;
            
            // Update active button
            document.querySelectorAll('#sdr [onclick*="setSDRBandwidth"] .selector-btn').forEach(btn => 
                btn.classList.remove('active'));
            button.classList.add('active');
            
            // Send to backend
            if (sdrWs) {
                sdrWs.send(JSON.stringify({
                    type: "set_bandwidth",
                    bandwidth: bandwidth
                }));
            }
            
            updateSDRBandwidthDisplay();
        }

        function setSDRFFTSize(fftSize, button) {
            sdrConfig.fftSize = fftSize;
            
            // Update active button
            document.querySelectorAll('#sdr [onclick*="setSDRFFTSize"] .selector-btn').forEach(btn => 
                btn.classList.remove('active'));
            button.classList.add('active');
            
            // Send to backend
            if (sdrWs) {
                sdrWs.send(JSON.stringify({
                    type: "set_fft_size",
                    fft_size: fftSize
                }));
            }
            
            updateSDRFFTDisplay();
        }

        function setSDRColorPalette(palette, button) {
            sdrConfig.colorPalette = palette;
            
            // Update active button
            document.querySelectorAll('#sdr [onclick*="setSDRColorPalette"] .selector-btn').forEach(btn => 
                btn.classList.remove('active'));
            button.classList.add('active');
        }

        function updateSDRSpeed(speed) {
            sdrConfig.scrollSpeed = parseInt(speed);
            document.getElementById('sdrSpeedValue').textContent = speed;
        }

        function updateSDRCanvasHeight(height) {
            document.getElementById('sdrHeightValue').textContent = `${height}px`;
            if (sdrCanvas) {
                sdrCanvas.style.height = `${height}px`;
                sdrConfig.canvasHeight = parseInt(height);
            }
        }

        function updateSDRBandwidthDisplay() {
            const bandwidth = sdrConfig.bandwidth;
            let display;
            
            if (bandwidth >= 1000000) {
                display = `${bandwidth / 1000000} MHz`;
            } else if (bandwidth >= 1000) {
                display = `${bandwidth / 1000} kHz`;
            } else {
                display = `${bandwidth} Hz`;
            }
            
            document.getElementById('sdrBandwidthDisplay').textContent = display;
        }

        function updateSDRFFTDisplay() {
            document.getElementById('sdrFFTSizeDisplay').textContent = sdrConfig.fftSize.toString();
        }

        function handleSDRClick(event) {
            if (!sdrRunning) return;
            
            const rect = sdrCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const canvasWidth = rect.width;
            
            // Calculate clicked frequency
            const clickPosition = x / canvasWidth; // 0 to 1
            const bandwidth = sdrConfig.bandwidth;
            const centerFreq = sdrConfig.centerFreq;
            
            const freqOffset = (clickPosition - 0.5) * bandwidth;
            const targetFreq = centerFreq + freqOffset;
            
            // Tune radio to clicked frequency
            console.log(`SDR click: tuning to ${targetFreq} Hz`);
            apiCall('/frequency/a', 'POST', { frequency: Math.round(targetFreq) })
                .then(() => {
                    logError(`Tuned to ${formatFrequencyPrecise(targetFreq)} via SDR waterfall`);
                })
                .catch(error => {
                    console.error('SDR tune failed:', error);
                    logError('SDR tune failed: ' + error.message);
                });
        }

        function showSDRFreqInput() {
            document.getElementById('sdrFreqDisplay').style.display = 'none';
            const input = document.getElementById('sdrFreqInput');
            input.style.display = 'inline-block';
            input.focus();
            input.select();
        }

        function hideSDRFreqInput() {
            document.getElementById('sdrFreqInput').style.display = 'none';
            document.getElementById('sdrFreqDisplay').style.display = 'block';
        }

        function submitSDRFreq() {
            const input = document.getElementById('sdrFreqInput');
            const freqStr = input.value.replace(/[^\d.]/g, ''); // Remove non-numeric
            const freqMHz = parseFloat(freqStr);
            
            if (isNaN(freqMHz) || freqMHz < 0.03 || freqMHz > 470) {
                alert('Invalid frequency. Enter frequency in MHz (0.03 - 470)');
                return;
            }
            
            const freqHz = Math.round(freqMHz * 1000000);
            console.log(`Setting SDR center frequency to ${freqHz} Hz`);
            
            // Update radio frequency (SDR will follow)
            apiCall('/frequency/a', 'POST', { frequency: freqHz })
                .then(() => {
                    hideSDRFreqInput();
                    logError(`SDR centered on ${formatFrequencyPrecise(freqHz)}`);
                })
                .catch(error => {
                    console.error('SDR frequency set failed:', error);
                    logError('SDR frequency set failed: ' + error.message);
                });
        }

        function updateSDRStatus(data) {
            console.log('SDR Status update:', data);
            if (data.status === 'stopped') {
                sdrRunning = false;
                const button = document.getElementById('sdrStartButton');
                button.textContent = '▶ START SDR';
                button.classList.remove('danger');
                button.classList.add('success');
                document.getElementById('sdrStreamStatus').textContent = 'STOPPED';
            }
        }

        // ── Initialization ──────────────────────────────────────
        function init() {
            console.log('Initializing FT-991A LCARS Interface...');
            connectWebSocket();
            initKnobControls();
            initWaterfall();
            updateLockoutDisplay();
            updateStepDisplay();
            
            // Set up navigation (both sidebar and mobile)
            document.querySelectorAll('.lcars-nav-item, .mobile-nav-item').forEach(nav => {
                nav.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = nav.dataset.tab;
                    switchTab(tabId);
                });
            });
            
            // Set up power slider
            const powerSlider = document.getElementById('powerSlider');
            if (powerSlider) {
                powerSlider.addEventListener('mouseup', function() {
                    const power = parseInt(this.value);
                    apiCall('/power', 'POST', { power: power });
                });
            }
            
            // Load initial status
            apiCall('/status').then(data => {
                if (data.connected) {
                    updateRadioStatus(data.status);
                }
            }).catch(error => {
                console.log('Initial status load failed:', error);
                logError('Initial status load failed: ' + error.message);
            });

            logError('FT-991A LCARS Interface initialized successfully');
        }

        // ── Event Listeners ─────────────────────────────────────
        
        // Prevent accidental PTT on mobile
        document.addEventListener('touchstart', function(e) {
            const pttButton = document.getElementById('pttButton');
            if (e.target === pttButton && txLockout) {
                e.preventDefault();
            }
        }, { passive: false });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Space bar for PTT (when not in input field)
            if (e.code === 'Space' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                e.preventDefault();
                if (!radioStatus.tx_active) {
                    pttPress();
                }
            }
            
            // Arrow keys for frequency nudging (when not in input field)
            if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                if (e.code === 'ArrowUp') {
                    e.preventDefault();
                    nudgeFrequency('up');
                } else if (e.code === 'ArrowDown') {
                    e.preventDefault();
                    nudgeFrequency('down');
                }
            }
        });

        document.addEventListener('keyup', function(e) {
            if (e.code === 'Space' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                e.preventDefault();
                pttRelease();
            }
        });

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>