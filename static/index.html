<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FT-991A Web GUI</title>
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-tertiary: #999999;
            --accent: #007acc;
            --accent-hover: #005999;
            --danger: #dc3545;
            --danger-hover: #c82333;
            --success: #28a745;
            --success-hover: #1e7e34;
            --warning: #ffc107;
            --warning-hover: #e0a800;
            --border: #666666;
            --shadow: 0 2px 10px rgba(0,0,0,0.3);
            --radius: 6px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger);
            transition: background 0.3s ease;
        }

        .status-indicator.connected {
            background: var(--success);
        }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Panel Styles */
        .panel {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .panel h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 5px;
        }

        /* Frequency Display */
        .frequency-display {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            text-align: center;
        }

        .frequency-value {
            font-size: 2.5rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: var(--accent);
        }

        .frequency-label {
            color: var(--text-tertiary);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* VFO Controls */
        .vfo-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .vfo-knob {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .knob-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .knob {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            border: 2px solid var(--border);
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: box-shadow 0.2s ease;
        }

        .knob:hover {
            box-shadow: 0 0 10px rgba(0,122,204,0.3);
        }

        .knob::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 20px;
            background: var(--accent);
            border-radius: 2px;
        }

        .knob-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        /* Input Groups */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .input-group label {
            min-width: 60px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Form Controls */
        input, select, button {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: var(--radius);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 5px rgba(0,122,204,0.3);
        }

        button {
            cursor: pointer;
            font-weight: 500;
            min-width: 80px;
            text-align: center;
        }

        button:hover {
            background: var(--bg-primary);
        }

        button.primary {
            background: var(--accent);
            border-color: var(--accent);
        }

        button.primary:hover {
            background: var(--accent-hover);
        }

        button.danger {
            background: var(--danger);
            border-color: var(--danger);
        }

        button.danger:hover {
            background: var(--danger-hover);
        }

        button.success {
            background: var(--success);
            border-color: var(--success);
        }

        button.success:hover {
            background: var(--success-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* PTT Button */
        .ptt-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .ptt-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 3px solid var(--border);
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .ptt-button:hover:not(:disabled) {
            border-color: var(--accent);
            background: var(--bg-primary);
        }

        .ptt-button.active {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220,53,69,0); }
            100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); }
        }

        .lockout-toggle {
            background: var(--warning);
            color: var(--bg-primary);
            border-color: var(--warning);
        }

        .lockout-toggle.active {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        /* Meters */
        .meter-container {
            margin-bottom: 20px;
        }

        .meter {
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 10px;
        }

        .meter-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .meter-value {
            font-weight: bold;
            color: var(--accent);
        }

        .meter-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* Band and Mode Selectors */
        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }

        .selector-button {
            padding: 8px 4px;
            font-size: 0.8rem;
            min-width: unset;
            text-align: center;
        }

        .selector-button.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Status Display */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .status-item {
            background: var(--bg-tertiary);
            padding: 10px;
            border-radius: var(--radius);
            text-align: center;
        }

        .status-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 5px;
        }

        .status-value {
            font-weight: bold;
            color: var(--text-primary);
        }

        .status-value.active {
            color: var(--success);
        }

        .status-value.danger {
            color: var(--danger);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .frequency-value {
                font-size: 2rem;
            }
            
            .ptt-button {
                width: 100px;
                height: 100px;
                font-size: 1rem;
            }
            
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group label {
                min-width: unset;
                margin-bottom: 5px;
            }
        }

        /* Utility Classes */
        .mt-10 { margin-top: 10px; }
        .mb-10 { margin-bottom: 10px; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .gap-10 { gap: 10px; }
        .hidden { display: none; }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>ðŸ“» FT-991A Web Control</h1>
        <div class="connection-status">
            <div class="status-indicator" id="connectionIndicator"></div>
            <span id="connectionText">Connecting...</span>
        </div>
    </div>

    <div class="container">
        <!-- Main Control Grid -->
        <div class="main-grid">
            <!-- Left Panel: Frequency & VFO -->
            <div class="panel">
                <h2>VFO Control</h2>
                
                <!-- VFO-A Display -->
                <div class="frequency-display">
                    <div class="frequency-value" id="frequencyA">14.074.000</div>
                    <div class="frequency-label">VFO-A (MHz)</div>
                </div>
                
                <!-- VFO Controls -->
                <div class="vfo-controls">
                    <div class="vfo-knob">
                        <div class="knob-container">
                            <div class="knob" id="tuneKnobA" data-vfo="a"></div>
                        </div>
                        <div class="knob-label">TUNE-A</div>
                    </div>
                    <div class="vfo-knob">
                        <div class="knob-container">
                            <div class="knob" id="tuneKnobB" data-vfo="b"></div>
                        </div>
                        <div class="knob-label">TUNE-B</div>
                    </div>
                </div>

                <!-- Direct Frequency Entry -->
                <div class="input-group">
                    <label>Freq:</label>
                    <input type="number" id="directFreq" placeholder="14074000" min="30000" max="470000000">
                    <button onclick="setDirectFrequency()">Set</button>
                </div>

                <!-- VFO Operations -->
                <div class="input-group">
                    <button onclick="swapVfo()">Aâ‡„B</button>
                    <button onclick="copyAtoB()">Aâ†’B</button>
                </div>

                <!-- VFO-B Display -->
                <div class="frequency-display" style="margin-top: 15px;">
                    <div class="frequency-value" id="frequencyB" style="font-size: 1.8rem;">14.074.000</div>
                    <div class="frequency-label">VFO-B (MHz)</div>
                </div>
            </div>

            <!-- Right Panel: Mode & Band -->
            <div class="panel">
                <h2>Mode & Band</h2>
                
                <!-- Current Mode Display -->
                <div class="input-group">
                    <label>Mode:</label>
                    <span id="currentMode" style="color: var(--accent); font-weight: bold;">DATA_USB</span>
                </div>

                <!-- Mode Selection -->
                <div class="selector-grid">
                    <button class="selector-button" onclick="setMode('LSB')">LSB</button>
                    <button class="selector-button" onclick="setMode('USB')">USB</button>
                    <button class="selector-button" onclick="setMode('CW')">CW</button>
                    <button class="selector-button" onclick="setMode('FM')">FM</button>
                    <button class="selector-button" onclick="setMode('AM')">AM</button>
                    <button class="selector-button" onclick="setMode('DATA_USB')">FT8</button>
                    <button class="selector-button" onclick="setMode('C4FM')">C4FM</button>
                    <button class="selector-button" onclick="setMode('DATA_LSB')">PSK</button>
                </div>

                <!-- Band Selection -->
                <h2 style="margin-top: 20px;">Band Selection</h2>
                <div class="selector-grid">
                    <button class="selector-button" onclick="setBand('160M')">160m</button>
                    <button class="selector-button" onclick="setBand('80M')">80m</button>
                    <button class="selector-button" onclick="setBand('40M')">40m</button>
                    <button class="selector-button" onclick="setBand('30M')">30m</button>
                    <button class="selector-button" onclick="setBand('20M')">20m</button>
                    <button class="selector-button" onclick="setBand('17M')">17m</button>
                    <button class="selector-button" onclick="setBand('15M')">15m</button>
                    <button class="selector-button" onclick="setBand('12M')">12m</button>
                    <button class="selector-button" onclick="setBand('10M')">10m</button>
                    <button class="selector-button" onclick="setBand('VHF_6M')">6m</button>
                    <button class="selector-button" onclick="setBand('VHF_2M')">2m</button>
                    <button class="selector-button" onclick="setBand('UHF_70CM')">70cm</button>
                </div>

                <!-- Quick FT8 Frequencies -->
                <h2 style="margin-top: 20px;">FT8 Quick</h2>
                <div class="selector-grid">
                    <button class="selector-button" onclick="setFT8Frequency(7074000)">40m</button>
                    <button class="selector-button" onclick="setFT8Frequency(14074000)">20m</button>
                    <button class="selector-button" onclick="setFT8Frequency(21074000)">15m</button>
                    <button class="selector-button" onclick="setFT8Frequency(28074000)">10m</button>
                </div>
            </div>
        </div>

        <!-- Second Row -->
        <div class="main-grid">
            <!-- PTT & TX Control -->
            <div class="panel">
                <h2>Transmit Control</h2>
                
                <div class="ptt-container">
                    <button class="ptt-button" id="pttButton" 
                            onmousedown="pttPress()" 
                            onmouseup="pttRelease()" 
                            ontouchstart="pttPress()" 
                            ontouchend="pttRelease()">
                        PTT
                    </button>
                    
                    <button class="lockout-toggle" id="lockoutButton" onclick="toggleLockout()">
                        ðŸ”’ TX LOCKOUT
                    </button>
                </div>

                <!-- TX Power Control -->
                <div class="input-group mt-10">
                    <label>Power:</label>
                    <input type="range" id="powerSlider" min="5" max="100" value="50" 
                           oninput="updatePower(this.value)">
                    <span id="powerValue" style="min-width: 40px; text-align: right;">50W</span>
                </div>

                <!-- TX Status -->
                <div class="status-grid mt-10">
                    <div class="status-item">
                        <div class="status-label">TX Status</div>
                        <div class="status-value" id="txStatus">RX</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">SWR</div>
                        <div class="status-value" id="swrValue">1.0:1</div>
                    </div>
                </div>
            </div>

            <!-- Meters & Status -->
            <div class="panel">
                <h2>Meters & Status</h2>
                
                <!-- S-Meter -->
                <div class="meter">
                    <div class="meter-label">
                        <span>S-Meter</span>
                        <span class="meter-value" id="sMeterValue">S0</span>
                    </div>
                    <div class="meter-bar">
                        <div class="meter-fill" id="sMeterBar" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Status Grid -->
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">Squelch</div>
                        <div class="status-value" id="squelchStatus">CLOSED</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Mode</div>
                        <div class="status-value" id="statusMode">USB</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Power Out</div>
                        <div class="status-value" id="powerOut">0W</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Lockout</div>
                        <div class="status-value" id="lockoutStatus">OFF</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audio Integration Notes Panel -->
        <div class="panel">
            <h2>ðŸŽ§ Audio Integration (Linux)</h2>
            <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 10px;">
                The FT-991A has a built-in USB sound card. For digital modes (FT8, PSK31, etc.) and audio monitoring:
            </p>
            <div style="background: var(--bg-tertiary); padding: 15px; border-radius: var(--radius); font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.4;">
                <div style="color: var(--accent); margin-bottom: 10px;"># List audio devices:</div>
                <div>pactl list short sources | grep -i yaesu</div>
                <div>pactl list short sinks | grep -i yaesu</div>
                <br>
                <div style="color: var(--accent); margin-bottom: 10px;"># Route audio for WSJT-X (FT8):</div>
                <div>pavucontrol  # Use GUI to select FT-991A as input/output</div>
                <br>
                <div style="color: var(--accent); margin-bottom: 10px;"># Command line routing:</div>
                <div>pactl set-default-source "alsa_input.usb-YAESU_FT-991A..."</div>
                <div>pactl set-default-sink "alsa_output.usb-YAESU_FT-991A..."</div>
            </div>
        </div>
    </div>

    <script>
        // â”€â”€ Global State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let ws = null;
        let radioStatus = {};
        let txLockout = false;
        let knobInteraction = false;

        // â”€â”€ WebSocket Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                // Attempt reconnection after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'status':
                    updateRadioStatus(data.data);
                    break;
                case 'connection':
                    updateConnectionStatus(data.status === 'connected');
                    break;
                default:
                    console.log('Unknown message type:', data.type);
            }
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'Connected';
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'Disconnected';
            }
        }

        // â”€â”€ Radio Status Updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateRadioStatus(status) {
            radioStatus = status;
            
            // Update frequency displays
            document.getElementById('frequencyA').textContent = formatFrequency(status.frequency_a);
            document.getElementById('frequencyB').textContent = formatFrequency(status.frequency_b);
            
            // Update mode
            document.getElementById('currentMode').textContent = status.mode;
            document.getElementById('statusMode').textContent = status.mode;
            
            // Update TX status
            const txStatus = document.getElementById('txStatus');
            const pttButton = document.getElementById('pttButton');
            if (status.tx_active) {
                txStatus.textContent = 'TX';
                txStatus.className = 'status-value danger';
                pttButton.classList.add('active');
            } else {
                txStatus.textContent = 'RX';
                txStatus.className = 'status-value';
                pttButton.classList.remove('active');
            }
            
            // Update squelch
            const squelch = document.getElementById('squelchStatus');
            squelch.textContent = status.squelch_open ? 'OPEN' : 'CLOSED';
            squelch.className = status.squelch_open ? 'status-value active' : 'status-value';
            
            // Update S-meter
            updateSMeter(status.s_meter);
            
            // Update power
            document.getElementById('powerOut').textContent = `${status.power_output}W`;
            
            // Update SWR
            document.getElementById('swrValue').textContent = formatSWR(status.swr);
            
            // Update lockout status
            txLockout = status.tx_lockout;
            updateLockoutDisplay();
        }

        function formatFrequency(hz) {
            const mhz = hz / 1000000;
            return mhz.toFixed(6);
        }

        function formatSWR(rawSwr) {
            // Convert raw SWR meter reading to ratio
            // This is an approximation - actual formula may vary
            const swr = 1 + (rawSwr / 255) * 4; // Scale to 1:1 - 5:1 range
            return `${swr.toFixed(1)}:1`;
        }

        function updateSMeter(level) {
            const percentage = (level / 255) * 100;
            document.getElementById('sMeterBar').style.width = `${percentage}%`;
            
            // Convert to S-units (approximate)
            let sValue;
            if (level < 42) sValue = 0;
            else if (level < 84) sValue = Math.floor((level - 42) / 6) + 1;
            else sValue = 9 + Math.floor((level - 84) / 17);
            
            if (sValue <= 9) {
                document.getElementById('sMeterValue').textContent = `S${sValue}`;
            } else {
                document.getElementById('sMeterValue').textContent = `S9+${(sValue - 9) * 10}`;
            }
        }

        // â”€â”€ API Calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`/api${endpoint}`, options);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`API call failed: ${endpoint}`, error);
                alert(`API call failed: ${error.message}`);
                throw error;
            }
        }

        // â”€â”€ Frequency Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function setDirectFrequency() {
            const freq = parseInt(document.getElementById('directFreq').value);
            if (isNaN(freq) || freq < 30000 || freq > 470000000) {
                alert('Invalid frequency. Enter frequency in Hz (30 kHz - 470 MHz)');
                return;
            }
            
            apiCall('/frequency/a', 'POST', { frequency: freq });
        }

        function setFT8Frequency(freq) {
            apiCall('/frequency/a', 'POST', { frequency: freq })
                .then(() => apiCall('/mode', 'POST', { mode: 'DATA_USB' }));
        }

        // â”€â”€ VFO Operations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function swapVfo() {
            apiCall('/vfo/swap', 'POST');
        }

        function copyAtoB() {
            apiCall('/vfo/a-to-b', 'POST');
        }

        // â”€â”€ Mode Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function setMode(mode) {
            apiCall('/mode', 'POST', { mode: mode });
        }

        // â”€â”€ Band Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function setBand(band) {
            apiCall('/band', 'POST', { band: band });
        }

        // â”€â”€ Power Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updatePower(watts) {
            document.getElementById('powerValue').textContent = `${watts}W`;
        }

        document.getElementById('powerSlider').addEventListener('mouseup', function() {
            const power = parseInt(this.value);
            apiCall('/power', 'POST', { power: power });
        });

        // â”€â”€ PTT Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function pttPress() {
            if (txLockout) {
                alert('TX Lockout is enabled. Disable lockout to transmit.');
                return;
            }
            
            apiCall('/ptt', 'POST', { enable: true });
        }

        function pttRelease() {
            apiCall('/ptt', 'POST', { enable: false });
        }

        // â”€â”€ TX Lockout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function toggleLockout() {
            apiCall('/lockout', 'POST').then(response => {
                txLockout = response.lockout;
                updateLockoutDisplay();
            });
        }

        function updateLockoutDisplay() {
            const button = document.getElementById('lockoutButton');
            const status = document.getElementById('lockoutStatus');
            
            if (txLockout) {
                button.classList.add('active');
                button.textContent = 'ðŸ”’ LOCKED';
                status.textContent = 'ON';
                status.className = 'status-value danger';
            } else {
                button.classList.remove('active');
                button.textContent = 'ðŸ”“ UNLOCKED';
                status.textContent = 'OFF';
                status.className = 'status-value';
            }
        }

        // â”€â”€ VFO Knob Simulation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function initKnobControls() {
            const knobs = document.querySelectorAll('.knob');
            
            knobs.forEach(knob => {
                let isDragging = false;
                let startAngle = 0;
                let currentRotation = 0;
                let lastFreq = 0;
                
                function getAngle(event) {
                    const rect = knob.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    const clientX = event.clientX || (event.touches && event.touches[0].clientX);
                    const clientY = event.clientY || (event.touches && event.touches[0].clientY);
                    
                    return Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
                }
                
                function startDrag(event) {
                    isDragging = true;
                    knobInteraction = true;
                    startAngle = getAngle(event);
                    
                    const vfo = knob.dataset.vfo;
                    lastFreq = vfo === 'a' ? radioStatus.frequency_a : radioStatus.frequency_b;
                    
                    event.preventDefault();
                }
                
                function drag(event) {
                    if (!isDragging) return;
                    
                    const currentAngle = getAngle(event);
                    let deltaAngle = currentAngle - startAngle;
                    
                    // Handle angle wrap-around
                    if (deltaAngle > 180) deltaAngle -= 360;
                    if (deltaAngle < -180) deltaAngle += 360;
                    
                    currentRotation += deltaAngle;
                    startAngle = currentAngle;
                    
                    // Update knob visual rotation
                    knob.style.transform = `rotate(${currentRotation}deg)`;
                    
                    // Calculate frequency change (1Â° = 1kHz for fine tuning)
                    const freqChange = Math.round(deltaAngle * 1000);
                    const newFreq = Math.max(30000, Math.min(470000000, lastFreq + freqChange));
                    
                    if (Math.abs(newFreq - lastFreq) >= 1000) { // Minimum 1kHz change
                        const vfo = knob.dataset.vfo;
                        const endpoint = vfo === 'a' ? '/frequency/a' : '/frequency/b';
                        
                        apiCall(endpoint, 'POST', { frequency: newFreq });
                        lastFreq = newFreq;
                    }
                    
                    event.preventDefault();
                }
                
                function endDrag() {
                    isDragging = false;
                    knobInteraction = false;
                }
                
                // Mouse events
                knob.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', endDrag);
                
                // Touch events
                knob.addEventListener('touchstart', startDrag);
                document.addEventListener('touchmove', drag);
                document.addEventListener('touchend', endDrag);
            });
        }

        // â”€â”€ Initialization â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function init() {
            console.log('Initializing FT-991A Web GUI...');
            connectWebSocket();
            initKnobControls();
            updateLockoutDisplay();
            
            // Load initial status
            apiCall('/status').then(data => {
                if (data.connected) {
                    updateRadioStatus(data.status);
                }
            }).catch(error => {
                console.log('Initial status load failed:', error);
            });
        }

        // â”€â”€ Event Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        
        // Prevent accidental PTT on mobile
        document.addEventListener('touchstart', function(e) {
            const pttButton = document.getElementById('pttButton');
            if (e.target === pttButton && txLockout) {
                e.preventDefault();
            }
        }, { passive: false });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Space bar for PTT (when not in input field)
            if (e.code === 'Space' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                e.preventDefault();
                if (!radioStatus.tx_active) {
                    pttPress();
                }
            }
        });

        document.addEventListener('keyup', function(e) {
            if (e.code === 'Space' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                e.preventDefault();
                pttRelease();
            }
        });

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>